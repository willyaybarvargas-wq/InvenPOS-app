<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvenPOS - Sistema de Inventario y Ventas</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

   <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- JsBarcode for Barcode Generation -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .active-nav { background-color: #eff6ff; color: #2563eb; font-weight: 600; }
        .loading-spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        [v-cloak] { display: none; }

        /* Styles for resizable columns */
        .resizable-table { table-layout: fixed; width: 100%; min-width: 1200px; }
        .resizable-table th { position: relative; }
        .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; }
        .resizer:hover, .resizing { border-right: 2px solid #4f46e5; }
        body.resizing { cursor: col-resize !important; user-select: none; }
        .table-cell-content { display: flex; align-items: center; gap: 8px; overflow: hidden; }
        .table-cell-content .copy-icon { visibility: hidden; flex-shrink: 0; }
        .resizable-table tr:hover .copy-icon { visibility: visible; }
        .actions-cell { position: relative; }
        .payment-method-btn.active { background-color: #e0e7ff; border-color: #6366f1; color: #4338ca; font-weight: 600; }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { 
          -moz-appearance: textfield;
          appearance: textfield;
        }
        .reports-tab.active, .settings-tab.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        /* Estilos para un scrollbar más delgado y moderno */
*::-webkit-scrollbar {
  width: 8px;
}
*::-webkit-scrollbar-track {
  background-color: #f1f5f9; /* Un gris muy claro */
}
*::-webkit-scrollbar-thumb {
  background-color: #cbd5e1; /* Un gris un poco más oscuro */
  border-radius: 10px;
  border: 2px solid #f1f5f9;
}
*::-webkit-scrollbar-thumb:hover {
    background-color: #94a3b8; /* Un gris más oscuro al pasar el mouse */
}
    </style>
</head>
<body class="bg-gray-100" :class="{ 'resizing': resizingIndex !== null }">

    <div id="app" v-cloak>
        <!-- ========== PANTALLA DE CARGA (SPLASH SCREEN) ========== -->
        <div v-if="currentView === 'splash'" class="flex flex-col items-center justify-center min-h-screen bg-indigo-600 text-white p-4 fade-in">
            <h1 class="text-6xl font-bold">InvenPOS</h1>
        </div>

        <!-- ========== PANTALLA DE LOGIN Y REGISTRO PRINCIPAL ========== -->
        <div v-if="currentView === 'auth'" class="flex items-center justify-center min-h-screen py-12">
            <div class="w-full max-w-md p-4 fade-in">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">InvenPOS</h1>
                        <p class="mt-2 text-gray-600">{{ authView === 'login' ? 'Inicia sesión en tu cuenta.' : (isCreatingInitialProfile ? 'Finaliza tu registro de administrador.' : 'Crea una nueva cuenta principal.') }}</p>
                    </div>
                    <!-- Formulario de Login -->
                    <form v-if="authView === 'login'" @submit.prevent="handleLogin" class="space-y-6">
                        <div v-if="authError" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg" v-text="authError"></div>
                        <div>
                            <label for="login-email" class="text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input id="login-email" type="email" v-model="form.email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="email">
                        </div>
                        <div>
                             <div class="flex items-center justify-between">
                                <label for="login-password" class="text-sm font-medium text-gray-700">Contraseña</label>
                                <button type="button" @click="authView = 'forgotPassword'" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">¿Olvidaste tu contraseña?</button>
                            </div>
                            <input id="login-password" type="password" v-model="form.password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="current-password">
                        </div>
                        <div>
                            <button type="submit" :disabled="isLoading" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-75">
                                <span v-if="!isLoading">Iniciar Sesión</span>
                                <div v-if="isLoading" class="loading-spinner"></div>
                            </button>
                        </div>
                        <p class="text-center text-sm text-gray-600">
                            ¿No tienes cuenta? <button type="button" @click="authView = 'register'; resetForm()" class="font-medium text-indigo-600 hover:text-indigo-500">Regístrate</button>
                        </p>
                    </form>
                    <!-- Formulario de Registro -->
                    <form v-if="authView === 'register'" @submit.prevent="handleRegister" class="space-y-4">
                         <div v-if="authError" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg" v-text="authError"></div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="reg-firstName" class="text-sm font-medium text-gray-700">Nombre(s)</label>
                                <input id="reg-firstName" type="text" v-model="form.firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="reg-lastName" class="text-sm font-medium text-gray-700">Apellido(s)</label>
                                <input id="reg-lastName" type="text" v-model="form.lastName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                         <div>
                            <label for="reg-phone" class="text-sm font-medium text-gray-700">Teléfono</label>
                            <input id="reg-phone" type="tel" v-model="form.phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="register-email" class="text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input id="register-email" type="email" v-model="form.email" required :disabled="isCreatingInitialProfile" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100">
                        </div>

                        <div v-if="!isCreatingInitialProfile">
                            <label for="register-password" class="text-sm font-medium text-gray-700">Contraseña</label>
                            <input id="register-password" type="password" v-model="form.password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="new-password">
                        </div>

                        <div v-if="isCreatingInitialProfile" class="space-y-4 border-t pt-4">
                             <div>
                                <label for="reg-employee-code" class="text-sm font-medium text-gray-700">Crear Código de Empleado (será tu contraseña de perfil)</label>
                                <input id="reg-employee-code" type="password" v-model="form.employeeCode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                             <div>
                                <label for="reg-confirm-code" class="text-sm font-medium text-gray-700">Confirmar Código</label>
                                <input id="reg-confirm-code" type="password" v-model="form.confirmEmployeeCode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="pt-4 grid grid-cols-2 gap-3">
    <button type="button" v-if="!isCreatingInitialProfile" @click="authView = 'login'; resetForm()" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        Volver
    </button>
    
    <button type="submit" :disabled="isLoading" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-75" :class="{ 'col-span-2': isCreatingInitialProfile }">
        <span v-if="!isLoading">{{ isCreatingInitialProfile ? 'Guardar Perfil y Finalizar' : 'Crear Cuenta' }}</span>
        <div v-if="isLoading" class="loading-spinner"></div>
    </button>
</div>
                    </form>
                    <!-- Formulario de Olvidé Contraseña -->
                    <form v-if="authView === 'forgotPassword'" @submit.prevent="handlePasswordReset" class="space-y-6">
                        <p class="text-sm text-gray-600">Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
                        <div v-if="authError" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg" v-text="authError"></div>
                        <div>
                            <label for="reset-email" class="text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input id="reset-email" type="email" v-model="form.email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <button type="submit" :disabled="isLoading" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-75">
                                <span v-if="!isLoading">Enviar Enlace</span>
                                <div v-if="isLoading" class="loading-spinner"></div>
                            </button>
                        </div>
                        <p class="text-center text-sm text-gray-600">
                            <button type="button" @click="authView = 'login'" class="font-medium text-indigo-600 hover:text-indigo-500">Volver a Iniciar Sesión</button>
                        </p>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ========== PANTALLA DE ACCESO POR PERFIL ========== -->
        <div v-if="currentView === 'profileLogin'" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-4 fade-in">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">Acceder Como</h1>
                        <p class="mt-2 text-gray-600">Ingresa con tu nombre y código de empleado.</p>
                    </div>
                    <form @submit.prevent="handleProfileLogin" class="space-y-6">
                        <div v-if="authError" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg" v-text="authError"></div>
                        <div>
                            <label for="profile-name" class="text-sm font-medium text-gray-700">Nombre de Usuario</label>
                            <input id="profile-name" type="text" v-model="form.firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="profile-code" class="text-sm font-medium text-gray-700">Código de Empleado</label>
                            <input id="profile-code" type="password" v-model="form.employeeCode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                        </div>
                        <div>
                            <button type="submit" :disabled="isLoading" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-75">
                                <span v-if="!isLoading">Acceder</span>
                                <div v-if="isLoading" class="loading-spinner"></div>
                            </button>
                        </div>
                    </form>
                    <div class="mt-6 border-t pt-6 text-center">
                         <button @click="openUserFormModal(null, true)" class="w-full text-sm font-medium text-indigo-600 hover:text-indigo-500">Crear Perfil Nuevo</button>
                         <button @click="handleLogout" class="mt-4 text-sm text-gray-600 hover:text-red-600">Cerrar sesión de {{ mainUser.email }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== CONTENEDOR PRINCIPAL DE LA APP (DASHBOARD) ========== -->
<div v-if="currentView === 'app'" class="flex h-screen bg-white fade-in overflow-hidden">            
    <!-- BARRA LATERAL -->
            <aside class="bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0 transition-all duration-300" :class="isSidebarCollapsed ? 'w-20' : 'w-56'">
                <div v-if="!isSidebarCollapsed" class="flex items-center justify-between px-4 border-b h-16 flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-900">InvenPOS</h1>
                    <button @click="isSidebarCollapsed = true" class="p-2 rounded-lg hover:bg-gray-200"><i data-lucide="chevron-left"></i></button>
                </div>
                <div v-if="isSidebarCollapsed" @click="isSidebarCollapsed = false" class="flex items-center justify-center border-b h-16 cursor-pointer hover:bg-gray-200 flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-900">IP</h1>
                </div>
                
                <nav class="flex-1 px-2 py-4 space-y-1">
                    <a v-if="userHasPermission('dashboard')" @click.prevent="setView('dashboard')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'dashboard', 'justify-center': isSidebarCollapsed}"><i data-lucide="layout-grid" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Dashboard</span></a>
                    <a v-if="userHasPermission('ventas')" @click.prevent="goToSalesView" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'sales' || mainView === 'openRegister', 'justify-center': isSidebarCollapsed}"><i data-lucide="shopping-cart" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Ventas</span></a>
                    <a v-if="userHasPermission('inventario')" @click.prevent="setView('inventory')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'inventory', 'justify-center': isSidebarCollapsed}"><i data-lucide="package" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Inventario</span></a>
                    <a v-if="userHasPermission('devoluciones')" @click.prevent="setView('returns')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'returns', 'justify-center': isSidebarCollapsed}"><i data-lucide="refresh-cw" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Devoluciones</span></a>
                    <a v-if="userHasPermission('clientes')" @click.prevent="setView('clients')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'clients', 'justify-center': isSidebarCollapsed}"><i data-lucide="users" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Clientes</span></a>
                    <a v-if="userHasPermission('reportes')" @click.prevent="setView('reports')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'reports', 'justify-center': isSidebarCollapsed}"><i data-lucide="bar-chart-3" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Reportes</span></a>
                    <a v-if="userHasPermission('configuracion')" @click.prevent="setView('settings')" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100" :class="{'active-nav': mainView === 'settings', 'justify-center': isSidebarCollapsed}"><i data-lucide="settings" class="w-5 h-5 flex-shrink-0"></i><span v-if="!isSidebarCollapsed" class="truncate">Configuración</span></a>
                </nav>
                <div class="p-2 border-t border-gray-200">
                     <div class="relative" ref="userMenuContainer">
                        <button @click="isUserMenuOpen = !isUserMenuOpen" class="w-full flex items-center gap-3 overflow-hidden text-left p-2 rounded-lg hover:bg-gray-200" :class="{'justify-center': isSidebarCollapsed}">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="w-6 h-6 text-indigo-600"></i></div>
                            <div v-if="!isSidebarCollapsed" class="flex-1">
                                <p class="text-sm font-semibold text-gray-800 truncate" v-text="employeeProfile.firstName + ' ' + employeeProfile.lastName"></p>
                        </button>
                        <div v-if="isUserMenuOpen" class="absolute bottom-full mb-2 w-56 bg-white rounded-md shadow-lg z-20 border border-gray-100 fade-in" :class="isSidebarCollapsed ? 'left-full ml-2' : 'left-0'">
                            <div class="p-2 border-b">
                                <p class="text-sm font-semibold text-gray-800 truncate" v-text="employeeProfile.firstName + ' ' + employeeProfile.lastName"></p>
                                <p class="text-xs text-gray-500 truncate" v-text="mainUser.email"></p>
                            </div>
                            <div class="py-1">
                                <a @click="switchToProfileSelection" href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="users-2" class="w-4 h-4 text-gray-500"></i><span>Cambiar Perfil</span></a>
                                <a @click="handleLogout" href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-red-600 hover:bg-red-50"><i data-lucide="log-out" class="w-4 h-4"></i><span>Cerrar Sesión</span></a>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="flex-1 p-4 md:p-6 flex flex-col overflow-y-auto">
                <!-- VISTA: APERTURA DE CAJA -->
                <div v-if="mainView === 'openRegister'" class="flex-1 flex flex-col items-center justify-center text-center">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                        <i data-lucide="archive" class="w-16 h-16 mx-auto text-indigo-500 mb-4"></i>
                        <h1 class="text-3xl font-bold text-gray-900">Apertura de Caja</h1>
                        <p class="text-gray-600 mt-2 mb-6">Ingresa el monto inicial en efectivo para comenzar tu turno.</p>
                        <div class="space-y-4">
                            <input type="number" v-model.number="initialAmountForm" @keyup.enter="handleOpenRegister" placeholder="0.00" class="block w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm text-2xl text-center focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button @click="handleOpenRegister" :disabled="initialAmountForm === null || initialAmountForm < 0" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center gap-2">
                                <i data-lucide="play-circle" class="w-5 h-5"></i><span>Iniciar Turno</span>
                            </button>
                        </div>
                    </div>
                </div>

<!-- VISTA: DASHBOARD -->
<div v-if="mainView === 'dashboard'" class="fade-in">
    <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
    <p class="text-gray-600 mt-1 mb-8">Resumen de la actividad de tu negocio en tiempo real.</p>

    <!-- Indicadores Clave (KPIs) - Ahora en 2 filas de 3 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
        <!-- Ventas del Día -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-blue-100 text-blue-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="sun" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Ventas del Día</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="formatCurrency(kpis.dailySales)">{{ formatCurrency(kpis.dailySales) }}</p>
            </div>
        </div>
        <!-- Ganancias del Día -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-green-100 text-green-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="trending-up" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Ganancias del Día</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="formatCurrency(kpis.dailyProfit)">{{ formatCurrency(kpis.dailyProfit) }}</p>
            </div>
        </div>
        <!-- Ventas en el Mes (Contador) -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="receipt" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Nº Ventas del Mes</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="kpis.monthlySalesCount">{{ kpis.monthlySalesCount }}</p>
            </div>
        </div>
        <!-- Ventas Totales del Mes -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-purple-100 text-purple-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="calendar" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Ventas del Mes</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="formatCurrency(kpis.monthlySales)">{{ formatCurrency(kpis.monthlySales) }}</p>
            </div>
        </div>
        <!-- Ganancias del Mes -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-emerald-100 text-emerald-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Ganancias del Mes</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="formatCurrency(kpis.monthlyProfit)">{{ formatCurrency(kpis.monthlyProfit) }}</p>
            </div>
        </div>
        <!-- Ticket Promedio del Mes -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-4 overflow-hidden">
            <div class="bg-orange-100 text-orange-600 p-3 rounded-full flex-shrink-0">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 truncate">Ticket Promedio</p>
                <p class="text-2xl font-bold text-gray-800 truncate" :title="formatCurrency(kpis.monthlyAverageTicket)">{{ formatCurrency(kpis.monthlyAverageTicket) }}</p>
            </div>
        </div>
    </div>

    <!-- Panel de Estado de Inventario con altura fija -->
    <div class="bg-white p-6 rounded-xl border border-gray-200 flex flex-col max-h-[32rem]"> <!-- Altura máxima para el panel -->
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex-shrink-0">Estado del Inventario</h2>
        
        <!-- Contenedor con scroll -->
        <div class="flex-grow overflow-y-auto pr-2">
            <div v-if="lowStockProducts.length === 0 && outOfStockProducts.length === 0" class="flex items-center justify-center h-full text-center py-12">
                <div>
                    <i data-lucide="check-circle-2" class="w-16 h-16 mx-auto text-green-500 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700">¡Todo en orden!</h3>
                    <p class="text-gray-500 mt-1">No hay productos con bajo stock o agotados.</p>
                </div>
            </div>
            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <!-- Productos Agotados -->
                <div>
                    <h3 class="font-semibold text-red-600 mb-3 sticky top-0 bg-white pb-2 z-10">Productos Agotados ({{ outOfStockProducts.length }})</h3>
                    <div v-if="outOfStockProducts.length > 0">
                        <ul class="space-y-2">
                            <li v-for="product in outOfStockProducts" :key="product.sku" class="flex justify-between items-center p-2 rounded-md bg-red-50">
                                <span class="text-sm font-medium text-gray-700">{{ product.name }}</span>
                                <span class="text-xs font-mono text-gray-500">{{ product.sku }}</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else class="text-sm text-gray-500 italic mt-4">No hay productos agotados.</p>
                </div>
                <!-- Productos con Bajo Stock -->
                <div>
                    <h3 class="font-semibold text-orange-600 mb-3 sticky top-0 bg-white pb-2 z-10">Productos con Bajo Stock ({{ lowStockProducts.length }})</h3>
                    <div v-if="lowStockProducts.length > 0">
                        <ul class="space-y-2">
                            <li v-for="product in lowStockProducts" :key="product.sku" class="flex justify-between items-center p-2 rounded-md bg-orange-50">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">{{ product.name }}</p>
                                    <p class="text-xs font-mono text-gray-500">{{ product.sku }}</p>
                                </div>
                                <span class="text-sm font-bold text-orange-700">{{ product.stock }} unidades</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else class="text-sm text-gray-500 italic mt-4">No hay productos con bajo stock.</p>
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- VISTA: VENTAS -->
                <div v-if="mainView === 'sales'" class="flex-1 flex gap-4 overflow-hidden">
                    <!-- Columna Izquierda: Productos -->
                    <div class="w-2/3 flex flex-col">
                        <div class="flex-shrink-0 mb-4 flex items-center gap-2">
                            <input type="text" v-model="salesSearchQuery" placeholder="Buscar productos..." class="w-full px-4 py-2 border rounded-lg flex-grow">
                            <button @click="openModal('barcodeScanner')" title="Escanear Código" class="flex-shrink-0 bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 flex items-center gap-2"><i data-lucide="barcode" class="w-5 h-5"></i></button>
                            <button @click="openModal('parkedSales')" title="Ventas Aparcadas" class="relative flex-shrink-0 bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 flex items-center gap-2">
                                <i data-lucide="pause-circle" class="w-5 h-5"></i>
                                <span v-if="parkedSales.length > 0" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{{ parkedSales.length }}</span>
                            </button>
                             <button @click="openModal('cashRegister')" title="Cerrar Caja" class="flex-shrink-0 bg-red-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-600 flex items-center gap-2">
                                <i data-lucide="archive-x" class="w-5 h-5"></i><span>Cerrar Caja</span>
                            </button>
                        </div>
                        <div class="flex-grow overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-2">
                            <div v-for="product in filteredSalesProducts" :key="product.sku" @click="addToCart(product)" class="border rounded-lg p-3 flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-md hover:border-indigo-500 transition-all" :class="{'opacity-50 cursor-not-allowed': product.stock === 0}">
                                <div class="relative w-full">
                                    <div class="w-16 h-16 mx-auto bg-gray-100 rounded-md flex items-center justify-center mb-2"><i data-lucide="package" class="w-8 h-8 text-gray-400"></i></div>
                                    <span v-if="product.onOffer" class="absolute top-0 left-0 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">OFERTA</span>
                                </div>
                                <p class="font-semibold text-sm truncate w-full">{{ product.name }}</p>
                                <p class="text-xs text-gray-500">Stock: {{ product.stock }}</p>
                                <div class="mt-1">
                                    <p v-if="product.onOffer" class="text-sm text-gray-500 line-through">{{ formatCurrency(product.salePrice) }}</p>
                                    <p class="font-bold text-red-600">{{ formatCurrency(product.offerPrice || product.salePrice) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha: Carrito -->
                    <div class="w-1/3 bg-gray-50 rounded-lg flex flex-col p-3">
                        <h2 class="text-lg font-bold mb-2">Carrito de Compras</h2>
                        <div class="flex items-center gap-2 mb-2 relative">
                            <input type="text" v-model="selectedCustomerName" @input="showClientSuggestions = true" placeholder="Buscar cliente..." class="text-xs w-full px-2 py-1 border rounded-lg flex-grow">
                            <div v-if="showClientSuggestions && clientSuggestions.length > 0" class="absolute top-full left-0 w-full bg-white border rounded-lg shadow-lg z-20 max-h-48 overflow-y-auto">
                                <a v-for="client in clientSuggestions" :key="client.id" @click.prevent="selectClient(client)" href="#" class="block px-3 py-2 text-xs hover:bg-gray-100">{{ client.firstName }} {{ client.lastName }}</a>
                            </div>
                             <button @click="openDiscountPopoverWithAdminCheck" data-discount-toggle class="flex-shrink-0 bg-gray-200 text-gray-700 font-semibold py-1 px-2 rounded-lg hover:bg-gray-300 flex items-center gap-1 text-xs"><i data-lucide="percent" class="w-3.5 h-3.5"></i></button>
                            <div v-if="isDiscountPopoverOpen" ref="discountPopover" class="absolute top-full right-0 mt-1 w-48 bg-white rounded-lg shadow-xl border z-20 p-3 fade-in">
                                <p class="text-sm font-semibold mb-2">Aplicar Descuento</p>
                                <div class="flex items-center">
                                    <div class="relative" ref="discountTypeSelectorContainer">
                                        <button @click="isDiscountTypeSelectorOpen = !isDiscountTypeSelectorOpen" class="flex items-center justify-center h-full px-2 py-1 text-sm border rounded-l-md bg-gray-50 hover:bg-gray-100 focus:outline-none">
                                            <span>{{ discountType === 'percentage' ? '%' : '$' }}</span>
                                            <i data-lucide="chevron-down" class="w-3 h-3 ml-1 text-gray-500"></i>
                                        </button>
                                        <div v-if="isDiscountTypeSelectorOpen" class="absolute bottom-full mb-1 w-full bg-white border rounded-md shadow-lg z-10">
                                            <a @click.prevent="selectDiscountType('percentage')" href="#" class="block px-3 py-1 text-sm hover:bg-gray-100">%</a>
                                            <a @click.prevent="selectDiscountType('fixed')" href="#" class="block px-3 py-1 text-sm hover:bg-gray-100">$</a>
                                        </div>
                                    </div>
                                    <input type="number" v-model.number="discountValue" class="w-full text-right border-t border-b border-r rounded-r-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow overflow-y-auto">
                            <div v-if="cart.length === 0" class="text-center text-gray-500 py-10">El carrito está vacío</div>
                            <ul v-else class="space-y-2">
                                <li v-for="(item, index) in cart" :key="item.sku" class="flex items-center gap-2">
                                    <div class="flex-grow">
                                        <p class="font-medium text-xs leading-tight">{{ item.name }}</p>
                                        <p class="text-xs text-gray-600">{{ formatCurrency(item.price) }}</p>
                                    </div>
                                    <div class="flex items-center gap-1 border rounded-md">
                                        <button @click="updateCartQuantity(index, -1)" class="px-1.5 py-0.5 hover:bg-gray-200 rounded-l-md">-</button>
                                        <input type="number" v-model.number="item.quantity" @change="validateCartQuantity(index)" class="w-8 text-center bg-transparent focus:outline-none text-sm">
                                        <button @click="updateCartQuantity(index, 1)" class="px-1.5 py-0.5 hover:bg-gray-200 rounded-r-md">+</button>
                                    </div>
                                    <button @click="removeFromCart(index)" class="text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </li>
                            </ul>
                        </div>
                        <div class="flex-shrink-0 pt-3 border-t text-sm space-y-1">
                            <div class="flex justify-between"><span>Subtotal</span><span>{{ formatCurrency(cartSubtotal) }}</span></div>
                            <div v-if="discountAmount > 0" class="flex justify-between text-red-600"><span>Descuento</span><span>- {{ formatCurrency(discountAmount) }}</span></div>
                            <div v-if="taxAmount > 0" class="flex justify-between"><span>Impuestos ({{businessInfo.taxRate}}%)</span><span>{{ formatCurrency(taxAmount) }}</span></div>
                            <div class="flex justify-between font-bold text-lg pt-1 border-t mt-1"><span>Total</span><span>{{ formatCurrency(cartTotal) }}</span></div>
                            <div class="grid grid-cols-2 gap-2 pt-2">
                                <button @click="handleParkSale" :disabled="cart.length === 0" class="w-full bg-gray-200 text-gray-800 font-semibold text-sm py-2 rounded-lg disabled:opacity-50">Aparcar</button>
                                <button @click="openModal('payment')" :disabled="cart.length === 0" class="w-full bg-green-500 text-white font-semibold text-sm py-2 rounded-lg disabled:opacity-50">Pagar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: INVENTARIO -->
                <div v-if="mainView === 'inventory'" class="flex flex-col h-full">
                    <div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2 mb-4">
                        <h1 class="text-2xl font-bold text-gray-800">Inventario</h1>
                        <div class="flex items-center gap-2 flex-grow sm:flex-grow-0">
                            <div class="relative flex-grow sm:flex-grow-0">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <input type="text" v-model="searchQuery" placeholder="Buscar..." class="bg-gray-50 pl-9 pr-3 py-1 border border-gray-300 rounded-lg w-full sm:w-48 text-xs focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="relative" ref="filterContainer">
                                <button @click="isFilterPopoverOpen = !isFilterPopoverOpen" class="bg-gray-50 border border-gray-300 font-semibold py-1 px-2.5 rounded-lg flex items-center gap-2 text-xs" :class="areFiltersActive ? 'bg-indigo-100 text-indigo-700' : 'text-gray-700 hover:bg-gray-200'"><i data-lucide="filter" class="w-4 h-4"></i> Filtros</button>
                                <div v-if="isFilterPopoverOpen" class="absolute top-full mt-2 w-72 bg-white rounded-xl shadow-lg border z-30 fade-in">
                                    <div class="p-4 space-y-4">
                                        <div>
                                            <label for="filter-category" class="font-medium text-gray-700 text-sm">Categoría:</label>
                                            <select id="filter-category" v-model="tempFilters.category" class="mt-1 w-full border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="all">Todas</option>
                                                <option v-for="cat in availableCategories" :key="cat" :value="cat">{{ cat }}</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="filter-status" class="font-medium text-gray-700 text-sm">Estado:</label>
                                            <select id="filter-status" v-model="tempFilters.status" class="mt-1 w-full border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="all">Todos</option>
                                                <option value="in_stock">En Stock</option>
                                                <option value="low_stock">Bajo Stock</option>
                                                <option value="out_of_stock">Agotado</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="px-4 py-3 bg-gray-50 flex justify-between items-center rounded-b-xl">
                                        <button @click="clearAndApplyFilters" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">Limpiar</button>
                                        <button @click="applyFilters" class="text-sm font-semibold bg-indigo-600 text-white py-1.5 px-4 rounded-md hover:bg-indigo-700">Aplicar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="openProductFormModal()" class="bg-indigo-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-indigo-700 flex items-center gap-2 text-xs"><i data-lucide="plus" class="w-4 h-4"></i> Añadir Producto</button>
                            <button @click="openKitFormModal()" class="bg-green-600 text-white font-semibold py-1 px-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 text-xs"><i data-lucide="box" class="w-4 h-4"></i> Crear Kit</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 flex-1 flex flex-col overflow-hidden">
                        <div v-if="selectedProducts.length > 0" class="p-3 border-b border-blue-200 bg-blue-50 flex items-center justify-between fade-in">
                            <span class="font-semibold text-sm text-blue-800">{{ areAllProductsSelected ? `Todos los ${totalProducts} productos seleccionados` : `${selectedProducts.length} de ${totalProducts} producto(s) seleccionado(s)` }}</span>
                            <div class="flex items-center gap-2">
                                <button @click="toggleSelectAllProducts" class="bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs font-semibold py-1 px-3 rounded-md">{{ areAllProductsSelected ? 'Deseleccionar todo' : 'Seleccionar todo' }}</button>
                                <button @click="handleCopySelected" class="bg-gray-500 text-white hover:bg-gray-600 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1.5"><i data-lucide="copy" class="w-3.5 h-3.5"></i>Copiar</button>
                                <button @click="handleExportSelected" class="bg-green-600 text-white hover:bg-green-700 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1.5"><i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar</button>
                                <button @click="handleDeleteSelected" class="bg-red-600 text-white hover:bg-red-700 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1.5"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i>Eliminar</button>
                            </div>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left resizable-table" ref="inventoryTable">
                               <thead class="border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th v-for="(header, index) in tableHeaders" :key="header.key" class="px-4 py-2 text-xs font-semibold text-gray-600 border-r border-gray-200 last:border-r-0" :style="{ width: header.width }">
                                            <input v-if="header.key === 'checkbox'" type="checkbox" class="rounded border-gray-300" v-model="areAllOnPageSelected">
                                            <span v-else class="truncate">{{ header.label }}</span>
                                            <div v-if="header.resizable" class="resizer" @mousedown="startResize($event, index)"></div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="isLoading"><td :colspan="tableHeaders.length" class="text-center p-8 text-gray-500">Cargando productos...</td></tr>
                                    <tr v-else-if="paginatedProducts.length === 0"><td :colspan="tableHeaders.length" class="text-center p-8 text-gray-500">No hay productos que coincidan con la búsqueda o los filtros.</td></tr>
                                    <tr v-for="product in paginatedProducts" :key="product.sku" class="border-b border-gray-200 last:border-b-0 hover:bg-gray-50 text-xs" :class="{'bg-blue-50': selectedProducts.includes(product.sku)}">
                                        <td class="px-4 py-1.5 border-r border-gray-200 text-center"><input type="checkbox" class="rounded border-gray-300" :value="product.sku" v-model="selectedProducts"></td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 font-medium text-gray-800 truncate" :title="product.name">
                                            <div class="table-cell-content">
                                                <i v-if="product.isKit" data-lucide="box" class="w-4 h-4 text-green-600 flex-shrink-0"></i>
                                                <span class="flex-1 w-0 truncate">{{ product.name }}</span>
                                                <button @click="copyToClipboard(product.name, 'Nombre')" class="copy-icon text-gray-400 hover:text-indigo-600"><i data-lucide="copy" class="w-3.5 h-3.5"></i></button>
                                            </div>
                                        </td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 truncate" :title="product.sku">
                                            <div class="table-cell-content">
                                                <span class="flex-1 w-0 truncate">{{ product.sku }}</span>
                                                <button @click="copyToClipboard(product.sku, 'SKU')" class="copy-icon text-gray-400 hover:text-indigo-600"><i data-lucide="copy" class="w-3.5 h-3.5"></i></button>
                                            </div>
                                        </td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 truncate" :title="product.category">{{ product.category }}</td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 truncate" :title="formatCurrency(product.purchasePrice)">{{ formatCurrency(product.purchasePrice) }}</td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 truncate" :title="product.onOffer && product.offerPrice ? `Oferta: ${formatCurrency(product.offerPrice)} (Original: ${formatCurrency(product.salePrice)})` : formatCurrency(product.salePrice)">
                                            <div v-if="product.onOffer && product.offerPrice">
                                                <span class="line-through text-gray-500">{{ formatCurrency(product.salePrice) }}</span>
                                                <span class="font-bold text-red-600 ml-1">{{ formatCurrency(product.offerPrice) }}</span>
                                            </div>
                                            <span v-else>{{ formatCurrency(product.salePrice) }}</span>
                                        </td>
                                        <td class="px-4 py-1.5 border-r border-gray-200 font-medium truncate" :title="product.stock + ' ' + product.unit">{{ product.stock + ' ' + product.unit }}</td>
                                        <td class="px-4 py-1.5 border-r border-gray-200"><span class="font-medium px-2.5 py-1 rounded-full" :class="getProductStatus(product.stock).class">{{ getProductStatus(product.stock).text }}</span></td>
                                        <td class="px-4 py-1.5 actions-cell">
                                            <div class="flex items-center justify-center gap-1">
                                                <button @click="openModal('stockAdjustment', { product })" title="Ajustar Stock" class="p-1.5 rounded-full hover:bg-gray-200 text-blue-600"><i data-lucide="arrow-up-down" class="w-4 h-4"></i></button>
                                                <button @click.stop="toggleDropdown(product.sku)" title="Más opciones" class="p-1.5 rounded-full hover:bg-gray-200 text-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                                            </div>
                                            <div v-if="activeDropdownId === product.sku" class="absolute right-4 mt-2 w-56 bg-white rounded-md shadow-lg z-20 border border-gray-100 fade-in">
                                                <div class="py-1">
                                                    <a @click.prevent="openModal('productHistory', { product })" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="history" class="w-4 h-4 text-gray-500"></i><span>Historial del producto</span></a>
                                                    <a @click.prevent="openProductFormModal(product)" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="edit" class="w-4 h-4 text-gray-500"></i><span>Editar</span></a>
                                                    <a @click.prevent="openModal('barcode', { product })" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="barcode" class="w-4 h-4 text-gray-500"></i><span>Generar código de barras</span></a>
                                                    <div class="border-t my-1"></div>
                                                    <a @click.prevent="handleDeleteProduct(product)" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar</span></a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-2 border-t border-gray-200 flex flex-wrap items-center justify-between gap-4 text-xs">
                           <span class="text-gray-600" v-text="paginationInfo"></span>
                           <div class="flex items-center gap-3">
                               <div class="flex items-center gap-2">
                                   <label for="rowsPerPage" class="text-gray-600">Filas:</label>
                                   <select v-model="rowsPerPage" id="rowsPerPage" class="border-gray-300 rounded-md text-xs focus:ring-indigo-500 focus:border-indigo-500">
                                       <option>10</option><option>25</option><option>50</option><option>100</option>
                                   </select>
                               </div>
                               <div class="flex items-center gap-1">
                                   <button @click="goToPage(1)" :disabled="currentPage === 1" class="p-1.5 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                   <button @click="prevPage" :disabled="currentPage === 1" class="p-1.5 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                   <span class="font-medium text-gray-700 px-2">Página {{ currentPage }} de {{ totalPages }}</span>
                                   <button @click="nextPage" :disabled="currentPage === totalPages" class="p-1.5 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                   <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages" class="p-1.5 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                               </div>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: CLIENTES -->
                <div v-if="mainView === 'clients'" class="flex flex-col h-full">
                    <div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2 mb-4">
                        <h1 class="text-2xl font-bold text-gray-800">Clientes</h1>
                        <div class="flex items-center gap-2 flex-grow sm:flex-grow-0">
                            <div class="relative flex-grow sm:flex-grow-0">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <input type="text" v-model="clientSearchQuery" placeholder="Buscar cliente..." class="bg-gray-50 pl-9 pr-3 py-1.5 border border-gray-300 rounded-lg w-full sm:w-64 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <button @click="openClientFormModal()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center gap-2 text-sm"><i data-lucide="plus" class="w-4 h-4"></i> Añadir Cliente</button>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 flex-1 flex flex-col overflow-hidden">
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-sm font-semibold text-gray-600">Nombre</th>
                                        <th class="px-4 py-3 text-sm font-semibold text-gray-600">Contacto</th>
                                        <th class="px-4 py-3 text-sm font-semibold text-gray-600">Balance de Crédito</th>
                                        <th class="px-4 py-3 text-sm font-semibold text-gray-600 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="filteredClients.length === 0"><td colspan="4" class="text-center p-8 text-gray-500">No se encontraron clientes.</td></tr>
                                    <tr v-for="client in filteredClients" :key="client.id" class="border-b border-gray-200 last:border-b-0 hover:bg-gray-50 text-sm">
                                        <td class="px-4 py-3 font-medium text-gray-800">{{ client.firstName }} {{ client.lastName }}</td>
                                        <td class="px-4 py-3 text-gray-600"><div>{{ client.phone }}</div><div class="text-xs">{{ client.email }}</div></td>
                                        <td class="px-4 py-3 font-semibold" :class="getClientBalance(client).class">{{ getClientBalance(client).formatted }}</td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center justify-center gap-2">
                                                <button @click="openModal('creditManagement', { client })" class="bg-blue-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-blue-700 text-xs">Gestionar Crédito</button>
                                                <div class="relative actions-cell">
                                                    <button @click.stop="toggleDropdown(client.id)" title="Más opciones" class="p-2 rounded-full hover:bg-gray-200 text-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                                                    <div v-if="activeDropdownId === client.id" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border border-gray-100 fade-in">
                                                        <div class="py-1">
                                                            <a @click.prevent="openClientFormModal(client)" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="edit" class="w-4 h-4 text-gray-500"></i><span>Editar Cliente</span></a>
                                                            <div class="border-t my-1"></div>
                                                            <a @click.prevent="confirmDeleteClient(client)" href="#" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Cliente</span></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA: DEVOLUCIONES -->
                <div v-if="mainView === 'returns'" class="flex flex-col h-full">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">Devoluciones</h1>
                        <p class="text-gray-600 mt-1">Busca una factura para procesar una devolución.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
                        <!-- Columna de Búsqueda y Detalles -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl border border-gray-200 flex flex-col">
                            <form @submit.prevent="handleFindInvoice">
                                <label for="invoice-search" class="text-sm font-medium text-gray-700">Buscar por Nº de Factura</label>
                                <div class="mt-1 flex gap-2">
                                    <input id="invoice-search" type="text" v-model="returnsInvoiceSearch" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700"><i data-lucide="search"></i></button>
                                </div>
                            </form>
                            <div v-if="foundInvoice" class="mt-6 pt-6 border-t fade-in">
                                <h3 class="font-semibold text-lg mb-2">Detalles de la Factura</h3>
                                <div class="space-y-1 text-sm">
                                    <p><strong>Factura Nº:</strong> {{ foundInvoice.invoiceNumber }}</p>
                                    <p><strong>Fecha:</strong> {{ foundInvoice.date }}</p>
                                    <p><strong>Cliente:</strong> {{ foundInvoice.client }}</p>
                                    <p><strong>Total:</strong> <span class="font-bold">{{ formatCurrency(foundInvoice.total) }}</span></p>
                                </div>
                            </div>
                        </div>
                        <!-- Columna de Items a Devolver -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 flex flex-col">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Items para Devolver</h2>
                            <div v-if="!foundInvoice" class="flex-1 flex items-center justify-center text-gray-500">
                                <p>Busca una factura para ver los productos.</p>
                            </div>
                            <div v-else class="flex-1 flex flex-col">
                                <div class="flex-grow overflow-y-auto -mx-6 px-6">
                                    <ul class="space-y-3">
                                        <li v-for="(item, index) in itemsToReturn" :key="index" class="p-3 border rounded-lg flex items-center gap-4">
                                            <div class="flex-shrink-0"><input type="checkbox" v-model="item.isReturning" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
                                            <div class="flex-grow">
                                                <p class="font-medium">{{ item.name }}</p>
                                                <p class="text-sm text-gray-600">Vendido: {{ item.quantity }} @ {{ formatCurrency(item.price) }}</p>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <label class="text-sm">Cantidad:</label>
                                                <input type="number" v-model.number="item.returnQuantity" :disabled="!item.isReturning" min="1" :max="item.quantity" class="w-16 text-center border-gray-300 rounded-md shadow-sm text-sm py-1 disabled:bg-gray-100">
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="mt-6 pt-6 border-t flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600">Total a Reembolsar</p>
                                        <p class="text-3xl font-bold text-indigo-600">{{ formatCurrency(totalRefundAmount) }}</p>
                                    </div>
                                    <button @click="openModal('returnProcessing')" :disabled="totalRefundAmount <= 0" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Procesar Devolución</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: REPORTES -->
                <div v-if="mainView === 'reports'" class="flex flex-col h-full">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">Reportes</h1>
                        <p class="text-gray-600 mt-1">Analiza el historial de tu negocio.</p>
                    </div>
                    
                    <!-- Pestañas de Reportes -->
                    <div class="flex items-center border-b border-gray-200 mb-6 overflow-x-auto">
                        <button @click="reportsView = 'sales'" class="reports-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600 flex-shrink-0" :class="{'active': reportsView === 'sales'}">Historial de Ventas</button>
                        <button @click="reportsView = 'returns'" class="reports-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600 flex-shrink-0" :class="{'active': reportsView === 'returns'}">Historial de Devoluciones</button>
                        <button @click="reportsView = 'cash_register'" class="reports-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600 flex-shrink-0" :class="{'active': reportsView === 'cash_register'}">Historial de Caja</button>
                        <button @click="reportsView = 'entries'" class="reports-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600 flex-shrink-0" :class="{'active': reportsView === 'entries'}">Historial de Entradas</button>
                        <button @click="reportsView = 'wastage'" class="reports-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600 flex-shrink-0" :class="{'active': reportsView === 'wastage'}">Historial de Mermas</button>
                    </div>

                    <!-- Contenido de Reportes -->
                    <div class="bg-white rounded-xl border border-gray-200 flex-1 flex flex-col overflow-hidden">
                        <!-- Historial de Ventas -->
                       <div v-if="reportsView === 'sales'" class="flex flex-col h-full">
    
    <div v-if="dateFilters.start && dateFilters.end" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 fade-in">
        <div class="bg-white p-4 rounded-xl border border-gray-200">
            <p class="text-sm text-gray-500">Ventas Totales (Período)</p>
            <p class="text-2xl font-bold text-blue-600">{{ formatCurrency(filteredPeriodTotalSales) }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl border border-gray-200">
            <p class="text-sm text-gray-500">Ganancia Total (Período)</p>
            <p class="text-2xl font-bold text-green-600">{{ formatCurrency(filteredPeriodTotalProfit) }}</p>
        </div>
    </div>

    <div class="p-4 border-b flex flex-wrap items-center justify-between gap-4">
        <div class="relative flex-grow sm:flex-grow-0">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input type="text" v-model="reportsSearch.sales" placeholder="Buscar por Nº Factura o Cliente..." class="w-full sm:w-64 pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex items-center gap-2">
            <div class="relative" ref="dateFilterContainer">
                <button @click="openDateFilter" class="bg-gray-50 border border-gray-300 font-semibold py-2 px-3 rounded-lg flex items-center gap-2 text-sm" :class="dateFilters.start ? 'bg-indigo-100 text-indigo-700' : 'text-gray-700 hover:bg-gray-200'">
                    <i data-lucide="calendar-days" class="w-4 h-4"></i>
                    <span>Filtrar por Fecha</span>
                </button>
                <div v-if="isDateFilterPopoverOpen" class="absolute top-full right-0 mt-2 w-72 bg-white rounded-xl shadow-lg border z-30 fade-in">
                    <div class="p-4 space-y-4">
                        <div>
                            <label for="filter-start-date" class="font-medium text-gray-700 text-sm">Desde:</label>
                            <input type="date" id="filter-start-date" v-model="tempDateFilters.start" class="mt-1 w-full border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="filter-end-date" class="font-medium text-gray-700 text-sm">Hasta:</label>
                            <input type="date" id="filter-end-date" v-model="tempDateFilters.end" class="mt-1 w-full border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="px-4 py-3 bg-gray-50 flex justify-between items-center rounded-b-xl">
                        <button @click="clearDateFilters" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">Limpiar</button>
                        <button @click="applyDateFilters" :disabled="!tempDateFilters.start || !tempDateFilters.end" class="text-sm font-semibold bg-indigo-600 text-white py-1.5 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50">Aplicar</button>
                    </div>
                </div>
            </div>
            <button @click="confirmDeleteAllSales" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span>Eliminar Todo</span>
            </button>
        </div>
    </div>
    
    <div class="overflow-auto flex-1">
        <table class="w-full text-left text-sm">
    <thead class="bg-gray-50 sticky top-0">
        <tr>
            <th class="p-3">Factura Nº</th>
            <th class="p-3">Fecha</th>
            <th class="p-3">Cliente</th>
            <th class="p-3">Cajero</th>
            <th class="p-3 text-right">Total Venta</th>
            <th class="p-3 text-right">Ganancia</th>
            <th class="p-3 text-center" title="Tiene Devolución"><i data-lucide="refresh-cw"></i></th>
            <th class="p-3 text-center">Acciones</th>
        </tr>
    </thead>
    <tbody>
        <tr v-if="filteredSalesHistory.length === 0"><td colspan="8" class="text-center p-8 text-gray-500">No hay ventas que coincidan.</td></tr>
        <tr v-for="sale in filteredSalesHistory" :key="sale.invoiceNumber" class="border-b hover:bg-gray-50">
            <td class="p-3 font-mono">{{ sale.invoiceNumber }}</td>
            <td class="p-3">{{ sale.date }}</td>
            <td class="p-3">{{ sale.client }}</td>
            <td class="p-3">{{ sale.cashier }}</td>
            <td class="p-3 text-right font-semibold" :class="{'text-red-500 line-through': sale.hasReturn}">{{ formatCurrency(sale.total) }}</td>
            <td class="p-3 text-right font-semibold text-green-600" :class="{'text-red-500 line-through': sale.hasReturn}">{{ formatCurrency(calculateSaleProfit(sale)) }}</td>
            <td class="p-3 text-center">
                <i v-if="sale.hasReturn" data-lucide="check" class="w-5 h-5 text-red-500 mx-auto"></i>
            </td>
            <td class="p-3 text-center">
                <button @click="openModal('invoice', { invoice: sale })" class="p-1.5 rounded-full hover:bg-blue-100 text-blue-600"><i data-lucide="eye"></i></button>
                <button @click="confirmDeleteSale(sale)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
            </td>
        </tr>
    </tbody>
</table>
    </div>

</div>

                        <!-- Historial de Devoluciones -->
                        <div v-if="reportsView === 'returns'" class="flex flex-col h-full">
                             <div class="p-4 border-b flex justify-between items-center">
                                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="reportsSearch.returns" placeholder="Buscar por Nº Factura o Producto..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <button @click="confirmDeleteAllReturns" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Todo</span></button>
                            </div>
                            <div class="overflow-auto flex-1">
                                <table class="w-full text-left text-sm">
    <thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Fecha</th><th class="p-3">Factura Original</th><th class="p-3">Producto(s)</th><th class="p-3">Usuario</th><th class="p-3 text-right">Monto Devuelto</th><th class="p-3 text-center">Acciones</th></tr></thead>
    <tbody>
        <tr v-if="filteredReturnsHistory.length === 0"><td colspan="6" class="text-center p-8 text-gray-500">No hay devoluciones registradas.</td></tr>
        <tr v-for="item in filteredReturnsHistory" :key="item.id" class="border-b hover:bg-gray-50">
            <td class="p-3">{{ new Date(item.timestamp).toLocaleString() }}</td>
            <td class="p-3 font-mono">{{ item.originalInvoiceNumber }}</td>
            <td class="p-3"><div v-for="prod in item.returnedItems" :key="prod.sku">{{ prod.name }} (x{{ prod.returnQuantity }})</div></td>
            <td class="p-3">{{ item.user }}</td>
            <td class="p-3 text-right font-semibold text-red-600">{{ formatCurrency(item.totalRefund) }}</td>
            <td class="p-3 text-center">
                <button @click="openModal('creditNote', { returnRecord: item })" class="p-1.5 rounded-full hover:bg-blue-100 text-blue-600" title="Ver Nota de Crédito"><i data-lucide="eye"></i></button>
                <button @click="confirmDeleteReturn(item)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
            </td>
        </tr>
    </tbody>
</table>
                            </div>
                        </div>

                        <!-- Historial de Caja -->
                        <div v-if="reportsView === 'cash_register'" class="flex flex-col h-full">
                            <div class="p-4 border-b flex justify-between items-center">
                                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="reportsSearch.cash" placeholder="Buscar por usuario o fecha..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <button @click="confirmDeleteAllCashSessions" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Todo</span></button>
                            </div>
                            <div class="overflow-auto flex-1">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Usuario</th><th class="p-3">Apertura</th><th class="p-3">Cierre</th><th class="p-3 text-right">Monto Esperado</th><th class="p-3 text-right">Monto Contado</th><th class="p-3 text-right">Diferencia</th><th class="p-3 text-center">Acciones</th></tr></thead>
                                    <tbody>
                                        <tr v-if="filteredCashRegisterHistory.length === 0"><td colspan="7" class="text-center p-8 text-gray-500">No hay cierres de caja registrados.</td></tr>
                                        <tr v-for="session in filteredCashRegisterHistory" :key="session.id" class="border-b hover:bg-gray-50">
                                            <td class="p-3 font-semibold">{{ session.user }}</td><td class="p-3">{{ new Date(session.startTime).toLocaleString() }}</td><td class="p-3">{{ new Date(session.endTime).toLocaleString() }}</td><td class="p-3 text-right">{{ formatCurrency(session.expectedCash) }}</td><td class="p-3 text-right">{{ formatCurrency(session.closingAmount) }}</td><td class="p-3 text-right font-bold" :class="getDifferenceClass(session.difference)">{{ formatCurrency(session.difference) }}</td>
                                            <td class="p-3 text-center">
    <button @click="confirmDeleteCashSession(session)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Historial de Entradas -->
                        <div v-if="reportsView === 'entries'" class="flex flex-col h-full">
                            <div class="p-4 border-b flex justify-between items-center">
                                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="reportsSearch.entries" placeholder="Buscar por producto o usuario..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <button @click="confirmDeleteAllEntries" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Todo</span></button>
                            </div>
                            <div class="overflow-auto flex-1">
                                <table class="w-full text-left text-sm">
    <thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Fecha</th><th class="p-3">Producto</th><th class="p-3">Usuario</th><th class="p-3">Motivo</th><th class="p-3 text-right">Cantidad</th><th class="p-3 text-right">Valor Total</th><th class="p-3 text-center">Acciones</th></tr></thead>
    <tbody>
        <tr v-if="filteredEntryHistory.length === 0"><td colspan="7" class="text-center p-8 text-gray-500">No hay entradas registradas.</td></tr>
        <tr v-for="item in filteredEntryHistory" :key="item.id" class="border-b hover:bg-gray-50">
            <td class="p-3">{{ new Date(item.timestamp).toLocaleString() }}</td><td class="p-3 font-medium">{{ item.productName }} <span class="text-gray-500 font-mono">({{ item.sku }})</span></td><td class="p-3">{{ item.user }}</td><td class="p-3">{{ item.note }}</td><td class="p-3 text-right font-semibold text-green-600">+{{ item.quantity }}</td><td class="p-3 text-right font-semibold">{{ formatCurrency(item.totalValue) }}</td>
            <td class="p-3 text-center">
                <button @click="openProductInfoModal(item)" title="Ver producto" class="p-1.5 rounded-full hover:bg-blue-100 text-blue-600"><i data-lucide="eye"></i></button>
                <button @click="confirmDeleteEntry(item)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
            </td>
        </tr>
    </tbody>
</table>
                            </div>
                        </div>

                        <!-- Historial de Mermas -->
                        <div v-if="reportsView === 'wastage'" class="flex flex-col h-full">
                            <div class="p-4 border-b flex justify-between items-center">
                                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="reportsSearch.wastage" placeholder="Buscar por producto o usuario..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <button @click="confirmDeleteAllWastage" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Todo</span></button>
                            </div>
                            <div class="overflow-auto flex-1">
                                <table class="w-full text-left text-sm">
    <thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Fecha</th><th class="p-3">Producto</th><th class="p-3">Usuario</th><th class="p-3">Motivo</th><th class="p-3 text-right">Cantidad</th><th class="p-3 text-right">Valor Perdido</th><th class="p-3 text-center">Acciones</th></tr></thead>
    <tbody>
        <tr v-if="filteredWastageHistory.length === 0"><td colspan="7" class="text-center p-8 text-gray-500">No hay mermas registradas.</td></tr>
        <tr v-for="item in filteredWastageHistory" :key="item.id" class="border-b hover:bg-gray-50">
            <td class="p-3">{{ new Date(item.timestamp).toLocaleString() }}</td><td class="p-3 font-medium">{{ item.productName }} <span class="text-gray-500 font-mono">({{ item.sku }})</span></td><td class="p-3">{{ item.user }}</td><td class="p-3">{{ item.note }}</td><td class="p-3 text-right">{{ item.quantity }}</td><td class="p-3 text-right font-semibold text-red-600">{{ formatCurrency(item.lostValue) }}</td>
            <td class="p-3 text-center">
                <button @click="openProductInfoModal(item)" title="Ver producto" class="p-1.5 rounded-full hover:bg-blue-100 text-blue-600"><i data-lucide="eye"></i></button>
                <button @click="confirmDeleteWastage(item)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
            </td>
        </tr>
    </tbody>
</table>text-left text-sm">
                                    <thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Fecha</th><th class="p-3">Producto</th><th class="p-3">Usuario</th><th class="p-3">Motivo</th><th class="p-3 text-right">Cantidad</th><th class="p-3 text-right">Valor Perdido</th><th class="p-3 text-center">Acciones</th></tr></thead>
                                    <tbody>
                                        <tr v-if="filteredWastageHistory.length === 0"><td colspan="7" class="text-center p-8 text-gray-500">No hay mermas registradas.</td></tr>
                                        <tr v-for="item in filteredWastageHistory" :key="item.id" class="border-b hover:bg-gray-50">
                                            <td class="p-3">{{ new Date(item.timestamp).toLocaleString() }}</td><td class="p-3 font-medium">{{ item.productName }} <span class="text-gray-500 font-mono">({{ item.sku }})</span></td><td class="p-3">{{ item.user }}</td><td class="p-3">{{ item.note }}</td><td class="p-3 text-right">{{ item.quantity }}</td><td class="p-3 text-right font-semibold text-red-600">{{ formatCurrency(item.lostValue) }}</td>
                                            <td class="p-3 text-center">
    <button @click="openProductInfoModal(item)" ...></button>
    <button @click="confirmDeleteWastage(item)" class="p-1.5 rounded-full hover:bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- VISTA: CONFIGURACIÓN -->
                <div v-if="mainView === 'settings'" class="flex flex-col h-full">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">Configuración</h1>
                        <p class="text-gray-600 mt-1">Gestiona los perfiles, datos del negocio y facturación.</p>
                    </div>

                    <!-- Pestañas de Configuración -->
                    <div class="flex items-center border-b border-gray-200 mb-6">
                        <button @click="settingsView = 'profiles'" class="settings-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600" :class="{'active': settingsView === 'profiles'}">Perfiles de Empleado</button>
                        <button @click="settingsView = 'business'" class="settings-tab px-4 py-3 font-semibold text-gray-600 border-b-2 border-transparent -mb-px hover:text-indigo-600" :class="{'active': settingsView === 'business'}">Negocio y Facturación</button>
                    </div>

                    <!-- Contenido de Pestañas -->
                    <div class="flex-1 overflow-y-auto">
                        <!-- Perfiles de Empleado -->
                        <div v-if="settingsView === 'profiles'" class="fade-in">
                            <div class="flex justify-end mb-4">
                                <button @click="openUserFormModal()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Crear Perfil</button>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <table class="w-full text-left">
                                <thead class="border-b border-gray-200 bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="p-4 text-sm font-semibold text-gray-600">Nombre</th>
                                            <th class="p-4 text-sm font-semibold text-gray-600">Código</th>
                                            <th class="p-4 text-sm font-semibold text-gray-600">Permisos</th>
                                            <th class="p-4 text-sm font-semibold text-gray-600 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="user in userList" :key="user.id" class="border-b border-gray-200 last:border-b-0">
                                            <td class="p-4"><div class="flex items-center gap-2"><span v-text="user.firstName + ' ' + user.lastName"></span><span v-if="user.id === employeeProfile.id" class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-100 text-green-800">Actual</span></div></td>
                                            <td class="p-4 text-gray-600" v-text="user.employeeCode"></td>
                                            <td class="p-4"><div class="max-h-24 overflow-y-auto"><div v-for="perm in user.permissions" :key="perm" class="text-xs font-medium mb-1 px-2.5 py-0.5 rounded-full bg-indigo-100 text-indigo-800 capitalize w-fit">{{ perm }}</div></div></td>
                                            <td class="p-4 text-right">
                                                <button 
                                                    @click="toggleUserBlockStatus(user)"
                                                    v-if="user.id !== employeeProfile.id"
                                                    class="font-semibold py-1 px-3 rounded-md text-xs mr-2"
                                                    :class="user.isBlocked ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'"
                                                    :title="user.isBlocked ? 'Desbloquear este perfil' : 'Bloquear este perfil'"
                                                >
                                                    {{ user.isBlocked ? 'Desbloquear' : 'Bloquear' }}
                                                </button>

                                                <button @click="openUserFormModal(user)" title="Editar" class="text-gray-500 hover:text-indigo-600 p-1"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                                <button @click="confirmDeleteUser(user)" v-if="user.id !== employeeProfile.id" title="Eliminar" class="text-gray-500 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Negocio y Facturación -->
                        <div v-if="settingsView === 'business'" class="fade-in">
                            <div class="bg-white p-6 rounded-xl border border-gray-200">
                                <form @submit.prevent="handleSaveBusinessInfo" class="space-y-8">
                                    <!-- Datos de la Empresa -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Datos de la Empresa</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label class="text-sm font-medium text-gray-700">Nombre del Negocio</label><input type="text" v-model="businessInfoForm.name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                            <div><label class="text-sm font-medium text-gray-700">RNC / Cédula</label><input type="text" v-model="businessInfoForm.rnc" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                        </div>
                                        <div><label class="text-sm font-medium text-gray-700">Dirección</label><input type="text" v-model="businessInfoForm.address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label class="text-sm font-medium text-gray-700">Teléfono</label><input type="tel" v-model="businessInfoForm.phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                            <div><label class="text-sm font-medium text-gray-700">URL del Logo</label><input type="url" v-model="businessInfoForm.logoUrl" placeholder="https://ejemplo.com/logo.png" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                        </div>
                                    </div>
                                    <!-- Configuración de Impuestos y Facturación -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Impuestos y Facturación</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                            <div>
                                                <label class="text-sm font-medium text-gray-700">Tasa de Impuesto (ej. ITBIS %)</label>
                                                <input type="number" step="0.1" v-model.number="businessInfoForm.taxRate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            </div>
                                            <div>
                                                <label class="flex items-center space-x-3 cursor-pointer">
                                                    <input type="checkbox" v-model="businessInfoForm.pricesIncludeTax" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                    <span class="text-sm text-gray-700">Los precios de venta ya incluyen este impuesto</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-700">Pie de Página del Recibo</label>
                                            <textarea v-model="businessInfoForm.receiptFooter" rows="3" placeholder="Ej: ¡Gracias por su compra! Las devoluciones se aceptan hasta 7 días después de la compra." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Cambios</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div> 
        
        <!-- =================================================================== -->
        <!-- ========================== MODALES ================================ -->
        <!-- =================================================================== -->

        <!-- MODAL PARA CREAR/EDITAR USUARIO -->
        <div v-if="activeModal === 'userForm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <div class="p-6 border-b"><h2 class="text-2xl font-bold text-gray-900">{{ modalData.isEditing ? 'Editar Perfil' : 'Crear Nuevo Perfil' }}</h2></div>
                <div class="p-6 overflow-y-auto" style="max-height: 60vh;">
                    <form @submit.prevent="handleSaveUser" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">Nombre(s)</label><input type="text" v-model="userForm.firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Apellido(s)</label><input type="text" v-model="userForm.lastName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">Código de Empleado</label><input type="text" v-model="userForm.employeeCode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Teléfono</label><input type="tel" v-model="userForm.phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div><label class="text-sm font-medium text-gray-700">Cargo / Puesto</label><input type="text" v-model="userForm.position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">Permisos de Acceso</label>
                            <div class="space-y-2">
                                <label v-for="perm in allPermissions" :key="perm" class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" :value="perm" v-model="userForm.permissions" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700 capitalize">{{ perm }}</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button @click="handleSaveUser" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN DE PERFIL DE ADMIN -->
        <div v-if="activeModal === 'adminConfirm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">{{ modalData.title }}</h2>
                <p class="text-sm text-gray-600 mb-6">{{ modalData.message }}</p>
                <form @submit.prevent="handleAdminAuthConfirm">
                    <div v-if="adminConfirm.error" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg mb-4" v-text="adminConfirm.error"></div>
                    <div class="space-y-4">
                        <div><label for="admin-username" class="text-sm font-medium text-gray-700">Nombre de Usuario</label><input id="admin-username" type="text" v-model="adminConfirm.form.firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="admin-code" class="text-sm font-medium text-gray-700">Código de Empleado</label><input id="admin-code" type="password" v-model="adminConfirm.form.employeeCode" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off"></div>
                    </div>
                    <div class="flex justify-end gap-3 pt-6">
                        <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                        <button type="submit" :disabled="isLoading" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center w-28">
                            <span v-if="!isLoading">Confirmar</span><div v-if="isLoading" class="loading-spinner"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL PARA AÑADIR/EDITAR PRODUCTO -->
        <div v-if="activeModal === 'productForm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col fade-in">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">{{ modalData.isEditing ? 'Editar Producto' : 'Añadir Nuevo Producto' }}</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: 70vh;">
                    <form @submit.prevent="handleAddOrUpdateProduct" class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-700">Nombre del Producto</label><input type="text" v-model="productForm.name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">SKU</label><input type="text" v-model="productForm.sku" :disabled="modalData.isEditing" placeholder="Se generará uno si está vacío" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100"></div>
                            <div><label class="text-sm font-medium text-gray-700">Categoría</label><input type="text" v-model="productForm.category" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div v-if="!modalData.isEditing"><label class="text-sm font-medium text-gray-700">Stock Inicial</label><input type="number" v-model.number="productForm.stock" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Unidad</label><select v-model="productForm.unit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option>Unidad</option><option>Kg</option><option>Litro</option><option>Metro</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">Precio de Compra ($)</label><input type="number" step="0.01" v-model.number="productForm.purchasePrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Precio de Venta ($)</label><input type="number" step="0.01" v-model.number="productForm.salePrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div><label class="text-sm font-medium text-gray-700">Margen de Ganancia (%)</label><div class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md" :class="{'text-red-600': profitMargin < 0}">{{ profitMargin }}%</div></div>
                        <div class="border-t pt-4 mt-4 space-y-4">
                            <label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" v-model="productForm.onOffer" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span class="text-sm font-medium text-gray-700">Poner producto en oferta</span></label>
                            <div v-if="productForm.onOffer" class="fade-in"><label class="text-sm font-medium text-gray-700">Precio de Oferta ($)</label><input type="number" step="0.01" v-model.number="productForm.offerPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                    </form>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button @click="handleAddOrUpdateProduct" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">{{ modalData.isEditing ? 'Guardar Cambios' : 'Guardar' }}</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL PARA AJUSTAR STOCK -->
        <div v-if="activeModal === 'stockAdjustment'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <div class="flex border-b">
                    <button @click="stockAdjustmentForm.mode = 'entrada'" class="flex-1 p-4 text-center font-semibold" :class="stockAdjustmentForm.mode === 'entrada' ? 'bg-green-100 text-green-700 border-b-2 border-green-500' : 'text-gray-500 hover:bg-gray-50'">Entrada (+)</button>
                    <button @click="stockAdjustmentForm.mode = 'salida'" class="flex-1 p-4 text-center font-semibold" :class="stockAdjustmentForm.mode === 'salida' ? 'bg-red-100 text-red-700 border-b-2 border-red-500' : 'text-gray-500 hover:bg-gray-50'">Salida / Merma (-)</button>
                </div>
                <div v-if="modalData.product" class="p-6 space-y-4">
                    <div>
                        <p class="font-bold text-gray-800">{{ modalData.product.name }}</p>
                        <p class="text-sm text-gray-500">SKU: {{ modalData.product.sku }}</p>
                        <p class="text-sm text-gray-500">Stock Actual: <span class="font-semibold">{{ modalData.product.stock }} {{ modalData.product.unit }}</span></p>
                    </div>
                    <div><label class="text-sm font-medium text-gray-700">{{ stockAdjustmentForm.mode === 'entrada' ? 'Cantidad a Añadir' : 'Cantidad a Retirar' }} ({{ modalData.product.unit }})</label><input type="number" v-model.number="stockAdjustmentForm.quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                    <div><label class="text-sm font-medium text-gray-700">Motivo / Nota</label><input type="text" v-model="stockAdjustmentForm.note" :placeholder="stockAdjustmentForm.mode === 'entrada' ? 'Ej: Compra a proveedor' : 'Ej: Producto dañado'" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                    <div><p class="text-sm text-gray-500">Usuario: <span class="font-medium text-gray-700">{{ employeeProfile.firstName }}</span></p></div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button @click="handleStockAdjustment" class="font-semibold py-2 px-4 rounded-md" :class="stockAdjustmentForm.mode === 'entrada' ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-red-600 text-white hover:bg-red-700'">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- MODAL HISTORIAL DE PRODUCTO -->
        <div v-if="activeModal === 'productHistory'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl flex flex-col fade-in max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Historial del Producto</h2>
                        <p v-if="modalData.product" class="text-sm text-gray-600">{{ modalData.product.name }} ({{ modalData.product.sku }})</p>
                    </div>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-4 border-b flex gap-4 items-center flex-shrink-0">
                    <div class="relative flex-grow"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="historySearchQuery" placeholder="Buscar en historial..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                    <button @click="confirmDeleteAllHistory" class="bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 flex items-center gap-2 text-sm flex-shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Eliminar Todo</span></button>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 sticky top-0"><tr><th class="py-2 px-4">Fecha</th><th class="py-2 px-4">Usuario</th><th class="py-2 px-4">Acción</th><th class="py-2 px-4">Cantidad</th><th class="py-2 px-4">Nota</th><th class="py-2 px-4 text-right">Acción</th></tr></thead>
                        <tbody>
                            <tr v-if="filteredHistory.length === 0"><td colspan="6" class="text-center p-8 text-gray-500">No hay registros que coincidan con la búsqueda.</td></tr>
                            <tr v-for="item in filteredHistory" :key="item.id" class="border-b hover:bg-gray-50">
                                <td class="py-2 px-4">{{ new Date(item.timestamp).toLocaleString() }}</td>
                                <td class="py-2 px-4">{{ item.user }}</td>
                                <td class="py-2 px-4"><span class="font-semibold" :class="item.type === 'entrada' ? 'text-green-600' : 'text-red-600'">{{ item.type === 'entrada' ? 'Entrada' : 'Salida' }}</span></td>
                                <td class="py-2 px-4 font-medium">{{ item.quantity }}</td>
                                <td class="py-2 px-4 text-gray-600">{{ item.note }}</td>
                                <td class="py-2 px-4 text-right"><button @click="confirmDeleteHistoryItem(item)" title="Eliminar registro" class="p-1.5 rounded-full hover:bg-red-100 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODAL CÓDIGO DE BARRAS -->
        <div v-if="activeModal === 'barcode'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col items-center p-8 fade-in">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Código de Barras</h2>
                <p v-if="modalData.product" class="text-sm text-gray-600 mb-6">{{ modalData.product.name }}</p>
                <svg id="barcode"></svg>
                <button @click="closeModal" class="mt-8 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700">Cerrar</button>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN GENÉRICO -->
        <div v-if="activeModal === 'confirm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
                <div class="flex items-start gap-4">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i></div>
                    <div class="mt-0 text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" v-text="modalData.title"></h3>
                        <div class="mt-2"><p class="text-sm text-gray-500" v-html="modalData.message"></p></div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
                    <button type="button" @click="executeConfirm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:w-auto sm:text-sm">Confirmar</button>
                    <button type="button" @click="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE NOTIFICACIÓN GENÉRICO -->
         <div v-if="activeModal === 'notification'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
                 <div class="flex items-start gap-4">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full" :class="modalData.type === 'success' ? 'bg-green-100' : 'bg-blue-100'">
                        <i v-if="modalData.type === 'success'" data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>
                        <i v-else data-lucide="info" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <div class="mt-0 text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" v-text="modalData.title"></h3>
                        <div class="mt-2"><p class="text-sm text-gray-500" v-text="modalData.message"></p></div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="closeModal" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:w-auto sm:text-sm">Entendido</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL PARA CREAR/EDITAR KIT -->
        <div v-if="activeModal === 'kitForm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl flex flex-col fade-in max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-2xl font-bold text-gray-900">{{ modalData.isEditing ? 'Editar Kit' : 'Crear Kit de Productos' }}</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-6 flex-grow overflow-hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col border border-gray-200 rounded-lg overflow-hidden">
                        <h3 class="p-4 font-semibold text-gray-800 border-b flex-shrink-0">Componentes del Kit ({{ kitForm.components.length }})</h3>
                        <div class="flex-grow overflow-y-auto p-2">
                            <div v-if="kitForm.components.length === 0" class="flex items-center justify-center h-full text-gray-500 text-sm">Añada productos de la lista de la derecha.</div>
                            <ul v-else class="space-y-2">
                                <li v-for="(component, index) in kitForm.components" :key="component.sku" class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50">
                                    <div><p class="font-medium text-sm">{{ component.name }}</p><p class="text-xs text-gray-500">SKU: {{ component.sku }}</p></div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" v-model.number="component.quantity" min="1" class="w-16 text-center border-gray-300 rounded-md text-sm py-1">
                                        <button @click="removeProductFromKit(index)" class="p-1.5 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex flex-col border border-gray-200 rounded-lg overflow-hidden">
                         <div class="p-3 border-b flex-shrink-0">
                            <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" v-model="kitComponentSearch" placeholder="Buscar productos..." class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div class="flex-grow overflow-y-auto p-2">
                            <ul class="space-y-1">
                                <li v-for="product in filteredKitComponents" :key="product.sku" @click="addProductToKit(product)" class="p-2 flex justify-between items-center rounded-md cursor-pointer hover:bg-indigo-50">
                                    <div><p class="font-medium text-sm">{{ product.name }}</p><p class="text-xs text-gray-500">SKU: {{ product.sku }}</p></div>
                                    <span class="text-sm text-gray-600">Stock: {{ product.stock }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg space-y-4 flex-shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="text-sm font-medium text-gray-700">Nombre del Kit</label><input type="text" v-model="kitForm.name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label class="text-sm font-medium text-gray-700">Stock Disponible</label><div class="mt-1 block w-full px-3 py-2 bg-gray-200 border border-gray-300 rounded-md">{{ maxKitStock }}</div><p class="text-xs text-gray-500 mt-1">Calculado según componentes.</p></div>
                        <div><label class="text-sm font-medium text-gray-700">Costo Total</label><div class="mt-1 block w-full px-3 py-2 bg-gray-200 border border-gray-300 rounded-md">{{ formatCurrency(kitTotalCost) }}</div></div>
                        <div><label class="text-sm font-medium text-gray-700">Precio de Venta ($)</label><input type="number" step="0.01" v-model.number="kitForm.salePrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                        <button @click="handleSaveKit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">{{ modalData.isEditing ? 'Guardar Cambios' : 'Guardar Kit' }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE PAGO -->
        <div v-if="activeModal === 'payment'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <div class="p-6 border-b flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Procesar Pago</h2>
                    <button v-if="paymentStep === 'input'" @click="goBackToPaymentSelection" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i>Volver</button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg border"><p class="text-sm text-gray-600">Total a Pagar:</p><p class="text-4xl font-bold text-gray-900">{{ formatCurrency(cartTotal) }}</p></div>
                    <div v-if="paymentStep === 'select'" class="space-y-3">
                        <label class="text-sm font-medium text-gray-700 block">Método de Pago</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="selectPaymentMethod('Efectivo')" class="payment-method-btn flex flex-col items-center justify-center p-4 border rounded-lg text-center"><i data-lucide="dollar-sign" class="w-6 h-6 mb-1"></i><span class="text-sm font-medium">Efectivo</span></button>
                            <button @click="selectPaymentMethod('Tarjeta')" class="payment-method-btn flex flex-col items-center justify-center p-4 border rounded-lg text-center"><i data-lucide="credit-card" class="w-6 h-6 mb-1"></i><span class="text-sm font-medium">Tarjeta</span></button>
                            <button @click="selectPaymentMethod('Transferencia')" class="payment-method-btn flex flex-col items-center justify-center p-4 border rounded-lg text-center"><i data-lucide="smartphone" class="w-6 h-6 mb-1"></i><span class="text-sm font-medium">Transferencia</span></button>
                            <button @click="selectPaymentMethod('Crédito')" :disabled="selectedClientId === null" class="payment-method-btn flex flex-col items-center justify-center p-4 border rounded-lg text-center disabled:opacity-50 disabled:cursor-not-allowed" title="Seleccione un cliente para usar crédito"><i data-lucide="user-check" class="w-6 h-6 mb-1"></i><span class="text-sm font-medium">Crédito</span></button>
                        </div>
                    </div>
                    <div v-if="paymentStep === 'input' && paymentMethod !== 'Mixto'" class="space-y-3">
                         <label for="amount-received" class="text-sm font-medium text-gray-700">Monto Recibido ({{ paymentMethod }})</label>
                        <input id="amount-received" type="number" v-model.number="amountReceived" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-lg text-right focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div v-if="paymentStep === 'input'" class="pt-4 space-y-2">
                        <div v-if="paymentMethod === 'Efectivo' && amountReceived > cartTotal" class="flex justify-between items-center text-lg text-green-600"><span class="font-bold">Cambio:</span><span class="font-bold">{{ formatCurrency(amountReceived - cartTotal) }}</span></div>
                        <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-700">Total Pagado:</span><span class="font-semibold text-gray-900">{{ formatCurrency(totalPaid) }}</span></div>
                        <div v-if="paymentRemaining > 0" class="flex justify-between items-center text-lg text-red-600"><span class="font-bold">Faltante:</span><span class="font-bold">{{ formatCurrency(paymentRemaining) }}</span></div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 flex justify-end gap-3 rounded-b-lg">
                    <button @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button v-if="paymentStep === 'input'" @click="processFinalSale" :disabled="!isPaymentComplete" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">Confirmar Pago</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE FACTURA -->
        <div v-if="activeModal === 'invoice'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm flex flex-col fade-in max-h-[90vh]">
                <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-lg font-bold text-gray-800">Factura de Venta</h2>
                    <button @click="closeInvoiceModal" class="p-1.5 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-4 flex-grow overflow-y-auto" style="font-family: 'Source Code Pro', monospace; color: #000;">
                    <div id="receipt-print-area" class="p-2">
                        <div class="text-center mb-4">
                            <img v-if="businessInfo.logoUrl" :src="businessInfo.logoUrl" alt="Logo" class="max-h-20 mx-auto mb-2">
                            <h3 class="font-bold text-lg">{{ businessInfo.name }}</h3>
                            <p class="text-xs">{{ businessInfo.address }}</p>
                            <p class="text-xs">Tel: {{ businessInfo.phone }}</p>
                            <p class="text-xs">RNC: {{ businessInfo.rnc }}</p>
                        </div>
                        <div class="border-t border-b border-dashed border-gray-400 my-2 py-1 text-xs">
                            <p><strong>FACTURA DE CONSUMO</strong></p><p><strong>FECHA:</strong> {{ modalData.invoice.date }}</p><p><strong>FACTURA Nº:</strong> {{ modalData.invoice.invoiceNumber }}</p>
                            <p><strong>CLIENTE:</strong> {{ modalData.invoice.client }}</p><p><strong>CAJERO:</strong> {{ modalData.invoice.cashier }}</p>
                        </div>
                        <table class="w-full text-xs">
                            <thead><tr><th class="text-left font-semibold">CANT</th><th class="text-left font-semibold">DESCRIPCION</th><th class="text-right font-semibold">TOTAL</th></tr></thead>
                            <tbody><tr v-for="item in modalData.invoice.items" :key="item.sku"><td>{{ item.quantity }}</td><td>{{ item.name }}<div class="text-gray-600">@ {{ formatCurrency(item.price) }}</div></td><td class="text-right">{{ formatCurrency(item.price * item.quantity) }}</td></tr></tbody>
                        </table>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-1 text-xs">
                            <div class="summary-line"><span>SUBTOTAL:</span> <span>{{ formatCurrency(modalData.invoice.subtotal) }}</span></div>
                            <div class="summary-line"><span>DESCUENTO:</span> <span>-{{ formatCurrency(modalData.invoice.discount) }}</span></div>
                            <div class="summary-line"><span>IMPUESTOS ({{businessInfo.taxRate}}%):</span> <span>{{ formatCurrency(modalData.invoice.tax) }}</span></div>
                            <div class="summary-line font-bold text-base mt-1"><span>TOTAL A PAGAR:</span> <span>{{ formatCurrency(modalData.invoice.total) }}</span></div>
                        </div>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-1 text-xs">
                            <div v-if="modalData.invoice.payments[0].method === 'Efectivo'">
                                <div class="summary-line"><span>PAGO (Efectivo):</span><span>{{ formatCurrency(modalData.invoice.amountReceived) }}</span></div>
                                <div v-if="modalData.invoice.change > 0" class="summary-line font-bold"><span>CAMBIO DEVUELTO:</span><span>{{ formatCurrency(modalData.invoice.change) }}</span></div>
                            </div>
                            <div v-else v-for="payment in modalData.invoice.payments" :key="payment.method" class="summary-line">
                                <span>PAGO ({{ payment.method }}):</span><span>{{ formatCurrency(payment.amount) }}</span>
                            </div>
                        </div>
                        <p class="text-center text-xs mt-4 whitespace-pre-wrap">{{ businessInfo.receiptFooter }}</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-3 flex-shrink-0">
                    <button @click="closeInvoiceModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cerrar</button>
                    <button @click="printInvoice" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i>Imprimir</button>
                </div>
            </div>
        </div> 
        <div v-if="activeModal === 'creditNote'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm flex flex-col fade-in max-h-[90vh]">
                <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-lg font-bold text-gray-800">Nota de Crédito / Devolución</h2>
                    <button @click="closeModal" class="p-1.5 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-4 flex-grow overflow-y-auto" style="font-family: 'Source Code Pro', monospace; color: #000;">
                    <div id="credit-note-print-area" class="p-2">
                        <div class="text-center mb-4">
                            <img v-if="businessInfo.logoUrl" :src="businessInfo.logoUrl" alt="Logo" class="max-h-20 mx-auto mb-2">
                            <h3 class="font-bold text-lg">{{ businessInfo.name }}</h3>
                            <p class="text-xs">{{ businessInfo.address }}</p>
                            <p class="text-xs">Tel: {{ businessInfo.phone }}</p>
                            <p class="text-xs">RNC: {{ businessInfo.rnc }}</p>
                        </div>
                        <div class="border-t border-b border-dashed border-gray-400 my-2 py-1 text-xs">
                            <p><strong>COMPROBANTE DE DEVOLUCIÓN</strong></p>
                            <p><strong>FECHA:</strong> {{ new Date(modalData.returnRecord.timestamp).toLocaleString('es-DO') }}</p>
                            <p><strong>DEVOLUCIÓN Nº:</strong> {{ modalData.returnRecord.id }}</p>
                            <p><strong>FACTURA ORIGINAL:</strong> {{ modalData.returnRecord.originalInvoiceNumber }}</p>
                            <p><strong>CAJERO:</strong> {{ modalData.returnRecord.user }}</p>
                        </div>
                        <p class="text-xs font-semibold">ARTÍCULOS DEVUELTOS:</p>
                        <table class="w-full text-xs">
                            <thead><tr><th class="text-left font-semibold">CANT</th><th class="text-left font-semibold">DESCRIPCION</th><th class="text-right font-semibold">TOTAL</th></tr></thead>
                            <tbody><tr v-for="item in modalData.returnRecord.returnedItems" :key="item.sku"><td>{{ item.returnQuantity }}</td><td>{{ item.name }}<div class="text-gray-600">@ {{ formatCurrency(item.price) }}</div></td><td class="text-right">{{ formatCurrency(item.price * item.returnQuantity) }}</td></tr></tbody>
                        </table>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-1 text-xs">
                            <div class="summary-line font-bold text-base mt-1"><span>TOTAL REEMBOLSADO:</span> <span>{{ formatCurrency(modalData.returnRecord.totalRefund) }}</span></div>
                        </div>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-1 text-xs">
                            <div class="summary-line"><span>MÉTODO:</span> <span class="font-semibold">{{ modalData.returnRecord.refundMethod }}</span></div>
                        </div>
                         <p class="text-center text-xs mt-4 whitespace-pre-wrap">{{ businessInfo.receiptFooter }}</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-3 flex-shrink-0">
                    <button @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cerrar</button>
                    <button @click="printCreditNote" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i>Imprimir</button>
                </div>
            </div>
        </div>


        <!-- MODAL DE VENTAS APARCADAS -->
        <div v-if="activeModal === 'parkedSales'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col fade-in max-h-[80vh]">
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <h2 class="text-2xl font-bold text-gray-900">Ventas Aparcadas</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-4 flex-grow overflow-y-auto">
                    <div v-if="parkedSales.length === 0" class="text-center text-gray-500 py-10">No hay ventas aparcadas.</div>
                    <ul v-else class="space-y-3">
                        <li v-for="(sale, index) in parkedSales" :key="index" class="p-4 border rounded-lg flex items-center justify-between hover:bg-gray-50">
                            <div><p class="font-semibold">Venta #{{ index + 1 }}</p><p class="text-sm text-gray-600">{{ sale.length }} producto(s) - Total: {{ formatCurrency(getParkedSaleTotal(sale)) }}</p></div>
                            <button @click="restoreParkedSale(index)" class="bg-indigo-600 text-white font-semibold py-1.5 px-4 rounded-md hover:bg-indigo-700">Restaurar</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- MODAL LECTOR DE CÓDIGO DE BARRAS -->
        <div v-if="activeModal === 'barcodeScanner'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm flex flex-col fade-in">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Escanear Producto</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-6">
                    <form @submit.prevent="handleScannedSku">
                        <p class="text-sm text-gray-600 mb-4">Ingrese el código SKU del producto manualmente.</p>
                        <div v-if="scannerError" class="text-sm text-center text-red-600 bg-red-50 p-3 rounded-lg mb-4" v-text="scannerError"></div>
                        <div><label for="sku-input" class="text-sm font-medium text-gray-700">Código de Barras (SKU)</label><input id="sku-input" type="text" v-model="scannedSku" ref="skuInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i><span>Añadir al Carrito</span></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- MODAL DE ARQUEO DE CAJA -->
        <div v-if="activeModal === 'cashRegister'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <template v-if="!isCashRegisterOpen">
                    <div class="p-6 border-b"><h2 class="text-2xl font-bold text-gray-900">Abrir Caja</h2><p class="text-sm text-gray-600 mt-1">Ingresa el monto inicial para comenzar el turno.</p></div>
                    <div class="p-6 space-y-4"><div><label for="initial-amount" class="text-sm font-medium text-gray-700">Monto Inicial en Caja</label><input id="initial-amount" type="number" v-model.number="initialAmountForm" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-lg text-right focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div></div>
                    <div class="p-4 border-t bg-gray-50 flex justify-end"><button @click="handleOpenRegister" :disabled="initialAmountForm === null || initialAmountForm < 0" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50">Iniciar Turno</button></div>
                </template>
                <template v-else>
                     <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">{{ cashRegisterData.closingAmount === null ? 'Cerrar Caja' : 'Resumen de Caja' }}</h2>
                        <button v-if="cashRegisterData.closingAmount !== null" @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                    </div>
                    <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
                        <div class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg border">
                            <div class="flex justify-between"><span class="text-gray-600">Apertura:</span><span class="font-medium">{{ formatCurrency(cashRegisterData.initialAmount) }}</span></div><hr>
                            <div class="flex justify-between"><span class="text-gray-600">Ventas en Efectivo:</span><span class="font-medium">{{ formatCurrency(cashSalesTotal) }}</span></div>
                            <div class="flex justify-between text-red-600"><span class="text-gray-600">Devoluciones en Efectivo:</span><span class="font-medium">-{{ formatCurrency(cashRefundsTotal) }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ventas con Tarjeta/Otros:</span><span class="font-medium">{{ formatCurrency(otherSalesTotal) }}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ventas a Crédito:</span><span class="font-medium">{{ formatCurrency(creditSalesTotal) }}</span></div>
                            <div class="flex justify-between font-semibold text-base pt-1"><span>Total Ventas:</span><span>{{ formatCurrency(totalSales) }}</span></div>
                        </div>
                        <div v-if="cashRegisterData.closingAmount === null" class="space-y-4 pt-4">
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-center"><p class="text-sm text-blue-800">Monto esperado en caja (Efectivo)</p><p class="text-2xl font-bold text-blue-900">{{ formatCurrency(expectedCashInRegister) }}</p></div>
                            <div><label for="closing-amount" class="text-sm font-medium text-gray-700">Monto Real Contado en Caja</label><input id="closing-amount" type="number" v-model.number="closingAmountForm" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-lg text-right focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div v-else class="space-y-3 pt-4">
                             <div class="flex justify-between items-center p-3 rounded-lg bg-gray-100"><span class="font-medium text-gray-800">Monto Esperado:</span><span class="text-lg font-semibold text-gray-900">{{ formatCurrency(expectedCashInRegister) }}</span></div>
                            <div class="flex justify-between items-center p-3 rounded-lg bg-gray-100"><span class="font-medium text-gray-800">Monto Contado:</span><span class="text-lg font-semibold text-gray-900">{{ formatCurrency(cashRegisterData.closingAmount) }}</span></div>
                            <div class="flex justify-between items-center p-3 rounded-lg" :class="cashDifferenceClass"><span class="font-bold text-lg">Diferencia:</span><span class="font-bold text-xl">{{ formatCurrency(cashDifference) }}</span></div>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
                        <template v-if="cashRegisterData.closingAmount === null">
                             <button @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                             <button @click="handleCloseRegister" :disabled="closingAmountForm === null || closingAmountForm < 0" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 disabled:opacity-50">Realizar Cierre</button>
                        </template>
                        <template v-else><button @click="finalizeAndResetRegister" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Finalizar y Cerrar Caja</button></template>
                    </div>
                </template>
            </div>
        </div>

        <!-- MODAL PARA AÑADIR/EDITAR CLIENTE -->
        <div v-if="activeModal === 'clientForm'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col fade-in">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">{{ modalData.isEditing ? 'Editar Cliente' : 'Añadir Nuevo Cliente' }}</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: 70vh;">
                    <form @submit.prevent="handleSaveClient" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">Nombre(s)</label><input type="text" v-model="clientForm.firstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Apellido(s)</label><input type="text" v-model="clientForm.lastName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-700">Teléfono</label><input type="tel" v-model="clientForm.phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="text-sm font-medium text-gray-700">Correo Electrónico</label><input type="email" v-model="clientForm.email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div><label class="text-sm font-medium text-gray-700">Dirección</label><input type="text" v-model="clientForm.address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label class="text-sm font-medium text-gray-700">RNC / Cédula</label><input type="text" v-model="clientForm.rnc" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                    </form>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button @click="handleSaveClient" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">{{ modalData.isEditing ? 'Guardar Cambios' : 'Guardar Cliente' }}</button>
                </div>
            </div>
        </div>

        <!-- MODAL GESTIONAR CRÉDITO -->
        <div v-if="activeModal === 'creditManagement'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col fade-in max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Gestión de Crédito</h2>
                        <p v-if="modalData.client" class="text-sm text-gray-600">{{ modalData.client.firstName }} {{ modalData.client.lastName }}</p>
                    </div>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div class="p-6 flex-grow overflow-y-auto">
                    <div class="p-4 rounded-lg mb-6 text-center" :class="getClientBalance(modalData.client).raw > 0 ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'">
                        <p class="text-sm font-medium" :class="getClientBalance(modalData.client).raw > 0 ? 'text-red-700' : 'text-green-700'">Balance Actual</p>
                        <p class="text-3xl font-bold" :class="getClientBalance(modalData.client).raw > 0 ? 'text-red-800' : 'text-green-800'">{{ getClientBalance(modalData.client).formatted }}</p>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Historial de Transacciones</h3>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50"><tr><th class="p-3">Fecha</th><th class="p-3">Tipo</th><th class="p-3">Descripción</th><th class="p-3 text-right">Monto</th></tr></thead>
                            <tbody>
                                <tr v-if="modalData.client.creditHistory.length === 0"><td colspan="4" class="text-center p-6 text-gray-500">No hay transacciones.</td></tr>
                                <tr v-for="tx in modalData.client.creditHistory" :key="tx.id" class="border-t">
                                    <td class="p-3">{{ new Date(tx.timestamp).toLocaleString() }}</td>
                                    <td class="p-3"><span class="font-semibold" :class="tx.type === 'abono' ? 'text-green-600' : 'text-red-600'">{{ tx.type === 'abono' ? 'Abono' : 'Cargo' }}</span></td>
                                    <td class="p-3 text-gray-600">{{ tx.note }}</td>
                                    <td class="p-3 text-right font-medium" :class="tx.type === 'abono' ? 'text-green-600' : 'text-red-600'">{{ tx.type === 'abono' ? '-' : '+' }}{{ formatCurrency(tx.amount) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex-shrink-0">
                    <form @submit.prevent="handleAddCreditTransaction" class="flex flex-wrap items-end gap-3">
                        <div class="flex-grow"><label class="text-xs font-medium text-gray-700">Tipo</label><select v-model="creditForm.type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"><option value="abono">Abono / Pago</option><option value="cargo">Cargo Manual</option></select></div>
                        <div class="flex-grow"><label class="text-xs font-medium text-gray-700">Monto</label><input type="number" step="0.01" v-model.number="creditForm.amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                        <div class="flex-grow-[2]"><label class="text-xs font-medium text-gray-700">Nota</label><input type="text" v-model="creditForm.note" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 text-sm">Añadir</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL PROCESAR DEVOLUCIÓN -->
        <div v-if="activeModal === 'returnProcessing'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <div class="p-6 border-b"><h2 class="text-2xl font-bold text-gray-900">Confirmar Devolución</h2></div>
                <div class="p-6 space-y-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg border">
                        <p class="text-sm text-gray-600">Total a Reembolsar:</p>
                        <p class="text-4xl font-bold text-red-600">{{ formatCurrency(totalRefundAmount) }}</p>
                    </div>
                    <div>
                        <label for="return-reason" class="text-sm font-medium text-gray-700">Motivo de la Devolución</label>
                        <input id="return-reason" type="text" v-model="returnForm.reason" placeholder="Ej: Cliente no satisfecho, talla incorrecta..." required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 block mb-1">Método de Reembolso</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="returnForm.refundMethod = 'Efectivo'" class="payment-method-btn flex items-center justify-center gap-2 p-3 border rounded-lg" :class="{'active': returnForm.refundMethod === 'Efectivo'}"><i data-lucide="dollar-sign"></i>Efectivo</button>
                            <button @click="returnForm.refundMethod = 'Credito Tienda'" class="payment-method-btn flex items-center justify-center gap-2 p-3 border rounded-lg" :class="{'active': returnForm.refundMethod === 'Credito Tienda'}"><i data-lucide="gift"></i>Crédito Tienda</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button @click="handleConfirmReturn" :disabled="!returnForm.reason || !returnForm.refundMethod" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 disabled:opacity-50">Confirmar</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL INFO DE PRODUCTO -->
        <div v-if="activeModal === 'productInfo'" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col fade-in">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Información del Producto</h2>
                    <button @click="closeModal" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
                </div>
                <div v-if="isLoading" class="p-8 text-center"><div class="loading-spinner mx-auto" style="width: 24px; height: 24px; border-top-color: #4f46e5;"></div></div>
                <div v-else-if="modalData.product" class="p-6 space-y-3">
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Nombre:</span><span class="font-semibold text-right">{{ modalData.product.name }}</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">SKU:</span><span class="font-mono text-right">{{ modalData.product.sku }}</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Categoría:</span><span class="font-semibold text-right">{{ modalData.product.category }}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Precio de Compra:</span><span class="font-semibold text-right">{{ formatCurrency(modalData.product.purchasePrice) }}</span></div>
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Precio de Venta:</span><span class="font-semibold text-right">{{ formatCurrency(modalData.product.salePrice) }}</span></div>
                    <div v-if="modalData.product.onOffer" class="flex justify-between items-center"><span class="text-sm text-gray-600">Precio de Oferta:</span><span class="font-semibold text-red-600 text-right">{{ formatCurrency(modalData.product.offerPrice) }}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Stock Actual:</span><span class="font-bold text-lg text-right">{{ modalData.product.stock }} {{ modalData.product.unit }}</span></div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="closeModal" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Cerrar</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, collection, query, where, getDocs, onSnapshot, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAirUkPrvsPd3MTB6OhuHShxbrtpYHoCUM",
            authDomain: "invenpos-296cf.firebaseapp.com",
            projectId: "invenpos-296cf",
            storageBucket: "invenpos-296cf.appspot.com",
            messagingSenderId: "1013572775238",
            appId: "1:1013572775238:web:c13db1898c07530a3fc947"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const businessesCollectionPath = `businesses`;

        createApp({
            data() {
                return {
                    // App State
                    currentView: 'splash',
                    authView: 'login',
                    mainView: 'inventory',
                    reportsView: 'sales',
                    settingsView: 'profiles',
                    isLoading: false,
                    authError: '',
                    isCreatingInitialProfile: false,
                    isSidebarCollapsed: false,
                    isUserMenuOpen: false,
                    activeDropdownId: null,
                    editingUserId: null,
                    editingProductId: null,
                    
                    // User & Auth
                    mainUser: null,
                    employeeProfiles: [],
                    employeeProfile: null,
                    userList: [],
                    
                    // Data & Histories
                    allProducts: [],
                    clients: [],
                    salesHistory: [],
                    cashRegisterHistory: [],
                    productHistory: [],
                    entryHistory: [],
                    wastageHistory: [],
                    returnsHistory: [],
                    businessInfo: { name: 'Tu Empresa S.R.L.', rnc: '1-2345678-9', address: 'Av. Principal 123, Santo Domingo', phone: '809-555-1234', logoUrl: '', taxRate: 18, pricesIncludeTax: false, receiptFooter: '¡Gracias por su compra!' },
                    
                    // Forms & Modals
                    activeModal: null,
                    modalData: {},
                    form: { email: '', password: '', firstName: '', lastName: '', employeeCode: '', phone: '' },
                    userForm: {},
                    productForm: {},
                    clientForm: {},
                    kitForm: { name: '', components: [], salePrice: 0 },
                    stockAdjustmentForm: { mode: 'entrada', quantity: null, note: '' },
                    creditForm: { type: 'abono', amount: null, note: '' },
                    returnForm: { reason: '', refundMethod: 'Efectivo' },
                    adminConfirm: { form: { firstName: '', employeeCode: '' }, error: '', onSuccess: () => {} },
                    businessInfoForm: {},

                    // Sales & Cart
                    cart: [],
                    parkedSales: [],
                    salesSearchQuery: '',
                    paymentStep: 'select',
                    paymentMethod: null,
                    amountReceived: null,
                    selectedClientId: null,
                    selectedCustomerName: 'Público en General',
                    showClientSuggestions: false,
                    isDiscountPopoverOpen: false,
                    isDiscountTypeSelectorOpen: false,
                    discountType: 'percentage',
                    discountValue: 0,
                    scannedSku: '',
                    scannerError: '',

                    // Returns
                    returnsInvoiceSearch: '',
                    foundInvoice: null,
                    itemsToReturn: [],

                    // Cash Register
                    isCashRegisterOpen: false,
                    cashRegisterData: { initialAmount: 0, sales: [], refunds: [], startTime: null, closingAmount: null, endTime: null },
                    initialAmountForm: null,
                    closingAmountForm: null,
                    
                    // Inventory & Reports
                    selectedProducts: [],
                    searchQuery: '',
                    clientSearchQuery: '',
                    historySearchQuery: '',
                    reportsSearch: { sales: '', cash: '', wastage: '', entries: '', returns: '' },
                    isDateFilterPopoverOpen: false,
                    tempDateFilters: {
    start: '',
    end: ''
},
                    dateFilters: {
                    start: '',
                    end: ''
                    },
                    kitComponentSearch: '',
                    isFilterPopoverOpen: false,
                    filters: { category: 'all', status: 'all' },
                    tempFilters: { category: 'all', status: 'all' },
                    tableHeaders: [
                        { key: 'checkbox', label: '', width: '40px', resizable: false },
                        { key: 'name', label: 'PRODUCTO', width: '25%', resizable: true },
                        { key: 'sku', label: 'SKU', width: '15%', resizable: true },
                        { key: 'category', label: 'CATEGORÍA', width: '15%', resizable: true },
                        { key: 'purchasePrice', label: 'P. COMPRA', width: '10%', resizable: true },
                        { key: 'salePrice', label: 'P. VENTA', width: '10%', resizable: true },
                        { key: 'stock', label: 'STOCK', width: '10%', resizable: true },
                        { key: 'status', label: 'ESTADO', width: '10%', resizable: true },
                        { key: 'actions', label: 'ACCIONES', width: '100px', resizable: true },
                    ],
                    resizingIndex: null,
                    resizingStartX: 0,
                    resizingStartWidth: 0,
                    
                    // Pagination
                    currentPage: 1,
                    rowsPerPage: 50,

                    // Static Data
                   allPermissions: ['dashboard', 'ventas', 'caja', 'inventario', 'devoluciones', 'clientes', 'reportes', 'configuracion', 'aplicar_descuento'],
                }  
            },
            computed: { 
  // Inventory Status Computeds
outOfStockProducts() {
    return this.allProducts.filter(p => !p.isKit && p.stock === 0);
},
lowStockProducts() {
    return this.allProducts.filter(p => !p.isKit && p.stock > 0 && p.stock < 10);
},

// KPIs Computeds
kpis() {
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
        const salesToday = this.salesHistory.filter(sale => sale.timestamp && sale.timestamp >= todayStart);
        const salesThisMonth = this.salesHistory.filter(sale => sale.timestamp && sale.timestamp >= monthStart);
        const returnsToday = this.returnsHistory.filter(ret => ret.timestamp && ret.timestamp >= todayStart);
        const returnsThisMonth = this.returnsHistory.filter(ret => ret.timestamp && ret.timestamp >= monthStart);
        const grossDailySales = salesToday.reduce((total, sale) => total + sale.total, 0);
        const totalDailyRefunds = returnsToday.reduce((total, ret) => total + ret.totalRefund, 0);
        const grossMonthlySales = salesThisMonth.reduce((total, sale) => total + sale.total, 0);
        const totalMonthlyRefunds = returnsThisMonth.reduce((total, ret) => total + ret.totalRefund, 0);
        const dailySales = grossDailySales - totalDailyRefunds;
        const monthlySales = grossMonthlySales - totalMonthlyRefunds;
        
        // AHORA LLAMA A LA FUNCIÓN DESDE METHODS
        const dailyProfitLoss = returnsToday.reduce((total, ret) => total + this.calculateReturnLoss(ret), 0);
        const monthlyProfitLoss = returnsThisMonth.reduce((total, ret) => total + this.calculateReturnLoss(ret), 0);

        const grossDailyProfit = salesToday.reduce((total, sale) => total + this.calculateSaleProfit(sale), 0);
        const dailyProfit = grossDailyProfit - dailyProfitLoss;
        const grossMonthlyProfit = salesThisMonth.reduce((total, sale) => total + this.calculateSaleProfit(sale), 0);
        const monthlyProfit = grossMonthlyProfit - monthlyProfitLoss;
        const monthlySalesCount = this.salesHistory.filter(sale => sale.timestamp && sale.timestamp >= monthStart).length;
        const monthlyAverageTicket = monthlySalesCount > 0 ? monthlySales / monthlySalesCount : 0;
        return {
            dailySales,
            dailyProfit,
            monthlySalesCount,
            monthlySales,
            monthlyProfit,
            monthlyAverageTicket
        };
    },
    filteredReturnsByDate() {
    if (!this.dateFilters.start || !this.dateFilters.end) {
        return []; // Si no hay filtro, no hay devoluciones que restar
    }
    const startDate = new Date(`${this.dateFilters.start}T00:00:00`).getTime();
    const endDate = new Date(`${this.dateFilters.end}T23:59:59`).getTime();
    // Filtra las devoluciones en el mismo rango de fechas que las ventas
    return this.returnsHistory.filter(ret => {
        if (ret && ret.timestamp) {
            return ret.timestamp >= startDate && ret.timestamp <= endDate;
        }
        return false;
    });
},

filteredSalesByDate() {
    if (!this.dateFilters.start || !this.dateFilters.end) {
        return this.salesHistory;
    }
    const startDate = new Date(`${this.dateFilters.start}T00:00:00`).getTime();
    const endDate = new Date(`${this.dateFilters.end}T23:59:59`).getTime();
    return this.salesHistory.filter(sale => {
        if (sale && sale.timestamp) {
            return sale.timestamp >= startDate && sale.timestamp <= endDate;
        }
        return false;
    });
},

filteredPeriodTotalSales() {
    const grossSales = this.filteredSalesByDate.reduce((total, sale) => total + sale.total, 0);
    const totalRefunds = this.filteredReturnsByDate.reduce((total, ret) => total + ret.totalRefund, 0);
    return grossSales - totalRefunds; // Devuelve el total NETO
},
filteredPeriodTotalProfit() {
    const grossProfit = this.filteredSalesByDate.reduce((total, sale) => total + this.calculateSaleProfit(sale), 0);
    const lostProfit = this.filteredReturnsByDate.reduce((total, ret) => total + this.calculateReturnLoss(ret), 0);
    return grossProfit - lostProfit; // Devuelve la ganancia NETA
},
                // Sales Computeds
                cartSubtotal() { return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0); },
                subtotalAfterDiscount() { return this.cartSubtotal - this.discountAmount; },
                taxAmount() {
                    if (!this.businessInfo.taxRate || this.businessInfo.taxRate <= 0) return 0;
                    const taxableAmount = this.subtotalAfterDiscount;
                    if (this.businessInfo.pricesIncludeTax) {
                        return taxableAmount - (taxableAmount / (1 + this.businessInfo.taxRate / 100));
                    } else {
                        return taxableAmount * (this.businessInfo.taxRate / 100);
                    }
                },
                cartTotal() {
                    if (this.businessInfo.pricesIncludeTax) {
                        return this.subtotalAfterDiscount;
                    } else {
                        return this.subtotalAfterDiscount + this.taxAmount;
                    }
                },
                discountAmount() { if (!this.discountValue || this.discountValue <= 0) return 0; return this.discountType === 'percentage' ? (this.cartSubtotal * this.discountValue) / 100 : this.discountValue; },
                 
                 // Inventory Computeds
                filteredProducts() {
                    let filtered = [...this.allProducts];
                    const normalizedQuery = this.normalizeString(this.searchQuery);

                    if (normalizedQuery) {
                        filtered = filtered.filter(p => 
                            this.normalizeString(p.name).includes(normalizedQuery) || 
                            this.normalizeString(p.sku).includes(normalizedQuery) || 
                            this.normalizeString(p.category).includes(normalizedQuery)
                        );
                    }
                    if (this.filters.category && this.filters.category !== 'all') {
                        filtered = filtered.filter(p => p.category === this.filters.category);
                    }
                    if (this.filters.status && this.filters.status !== 'all') {
                        filtered = filtered.filter(p => {
                            if (this.filters.status === 'in_stock') return p.stock >= 10;
                            if (this.filters.status === 'low_stock') return p.stock > 0 && p.stock < 10;
                            if (this.filters.status === 'out_of_stock') return p.stock === 0;
                            return true;
                        });
                    }
                    return filtered;
                },
                totalProducts() {
                    return this.filteredProducts.length;
                },
                paginatedProducts() {
                    const start = (this.currentPage - 1) * this.rowsPerPage;
                    const end = start + parseInt(this.rowsPerPage);
                    return this.filteredProducts.slice(start, end);
                },
                // Client Computeds
                filteredClients() {
                    const query = this.normalizeString(this.clientSearchQuery);
                    if (!query) return this.clients;
                    return this.clients.filter(c => 
                        this.normalizeString(c.firstName).includes(query) || this.normalizeString(c.lastName).includes(query) ||
                        this.normalizeString(c.phone).includes(query) || this.normalizeString(c.email).includes(query)
                    );
                },
                clientSuggestions() {
                    if (this.selectedCustomerName === 'Público en General' || !this.selectedCustomerName) return [];
                    const query = this.normalizeString(this.selectedCustomerName);
                    return this.clients.filter(c => this.normalizeString(c.firstName).includes(query) || this.normalizeString(c.lastName).includes(query)).slice(0, 5);
                },
                // History Modal
                filteredHistory() {
                    if (!this.productHistory) return [];
                    const query = this.normalizeString(this.historySearchQuery);
                    if (!query) return this.productHistory;
                    return this.productHistory.filter(item => 
                        this.normalizeString(new Date(item.timestamp).toLocaleString()).includes(query) ||
                        this.normalizeString(item.user).includes(query) || this.normalizeString(item.type).includes(query) ||
                        this.normalizeString(item.note).includes(query)
                    );
                },
                // Cash Register Computeds
                cashSalesTotal() { return this.cashRegisterData.sales.flatMap(s => s.payments).filter(p => p.method === 'Efectivo').reduce((t, p) => t + p.amount, 0); },
                cashRefundsTotal() { return this.cashRegisterData.refunds.filter(r => r.refundMethod === 'Efectivo').reduce((t, r) => t + r.totalRefund, 0); },
                otherSalesTotal() { return this.cashRegisterData.sales.flatMap(s => s.payments).filter(p => p.method === 'Tarjeta' || p.method === 'Transferencia').reduce((t, p) => t + p.amount, 0); },
                creditSalesTotal() { return this.cashRegisterData.sales.flatMap(s => s.payments).filter(p => p.method === 'Crédito').reduce((t, p) => t + p.amount, 0); },
                totalSales() { return this.cashRegisterData.sales.reduce((t, s) => t + s.total, 0); },
                expectedCashInRegister() { return this.cashRegisterData.initialAmount + this.cashSalesTotal - this.cashRefundsTotal; },
                cashDifference() { return this.cashRegisterData.closingAmount !== null ? this.cashRegisterData.closingAmount - this.expectedCashInRegister : 0; },
                cashDifferenceClass() {
                    const diff = this.cashDifference;
                    if (diff === 0) return 'bg-green-100 text-green-800';
                    return diff > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                },
                // Payment Modal Computeds
                totalPaid() { return Number(this.amountReceived) || 0; },
                paymentRemaining() { const rem = this.cartTotal - this.totalPaid; return Math.abs(rem) < 0.001 ? 0 : rem; },
                isPaymentComplete() { return this.amountReceived >= this.cartTotal; },
                availableCategories() { return [...new Set(this.allProducts.map(p => p.category))]; },
                areFiltersActive() { return this.filters.category !== 'all' || this.filters.status !== 'all'; },
                totalPages() { return Math.ceil(this.totalProducts / this.rowsPerPage); },
                paginationInfo() {
                    if (this.totalProducts === 0) return "No hay productos";
                    const start = (this.currentPage - 1) * this.rowsPerPage + 1;
                    const end = Math.min(this.currentPage * this.rowsPerPage, this.totalProducts);
                    return `Mostrando ${start}-${end} de ${this.totalProducts} productos`;
                },
                areAllOnPageSelected: {
                    get() { const pageSkus = this.paginatedProducts.map(p => p.sku); return pageSkus.length > 0 && pageSkus.every(sku => this.selectedProducts.includes(sku)); },
                    set(value) {
                        const pageSkus = this.paginatedProducts.map(p => p.sku);
                        if (value) { pageSkus.forEach(sku => { if (!this.selectedProducts.includes(sku)) this.selectedProducts.push(sku); }); } 
                        else { this.selectedProducts = this.selectedProducts.filter(sku => !pageSkus.includes(sku)); }
                    }
                },
                areAllProductsSelected() { return this.totalProducts > 0 && this.selectedProducts.length === this.totalProducts; },
                profitMargin() {
                    const purchase = parseFloat(this.productForm.purchasePrice);
                    const sale = parseFloat(this.productForm.salePrice);
                    return (sale > 0 && purchase >= 0) ? (((sale - purchase) / sale) * 100).toFixed(2) : '0.00';
                },
                // Kit Computeds
                filteredKitComponents() { const query = this.normalizeString(this.kitComponentSearch); return this.allProducts.filter(p => !p.isKit && (this.normalizeString(p.name).includes(query) || this.normalizeString(p.sku).includes(query))); },
                kitTotalCost() { return this.kitForm.components.reduce((total, c) => total + (c.purchasePrice * c.quantity), 0); },
                maxKitStock() {
                    if (this.kitForm.components.length === 0) return 0;
                    const stockLimits = this.kitForm.components.map(c => {
                        const p = this.allProducts.find(prod => prod.sku === c.sku);
                        return (!p || !c.quantity) ? Infinity : Math.floor(p.stock / c.quantity);
                    });
                    return Math.min(...stockLimits);
                },
                filteredSalesProducts() { const query = this.normalizeString(this.salesSearchQuery); return query ? this.allProducts.filter(p => this.normalizeString(p.name).includes(query) || this.normalizeString(p.sku).includes(query)) : this.allProducts; },
                
                // Returns Computeds
                totalRefundAmount() {
                    return this.itemsToReturn.reduce((total, item) => {
                        if (item.isReturning && item.returnQuantity > 0) {
                            return total + (item.price * item.returnQuantity);
                        }
                        return total;
                    }, 0);
                },

                // Reports Computeds
                filteredSalesHistory() {
    const sourceData = this.filteredSalesByDate;
    const query = this.normalizeString(this.reportsSearch.sales);

    let filtered = sourceData;
    if (query) {
        filtered = sourceData.filter(s => this.normalizeString(s.invoiceNumber).includes(query) || this.normalizeString(s.client).includes(query));
    }

    // AÑADIMOS UN INDICADOR A CADA VENTA PARA SABER SI TIENE DEVOLUCIÓN
    return filtered.map(sale => {
        const hasReturn = this.returnsHistory.some(ret => ret.originalInvoiceNumber === sale.invoiceNumber);
        return { ...sale, hasReturn };
    });
},

                filteredReturnsHistory() {
                    const query = this.normalizeString(this.reportsSearch.returns);
                    if (!query) return this.returnsHistory;
                    return this.returnsHistory.filter(r => 
                        this.normalizeString(r.originalInvoiceNumber).includes(query) ||
                        r.returnedItems.some(item => this.normalizeString(item.name).includes(query))
                    );
                },
                filteredCashRegisterHistory() {
                    const query = this.normalizeString(this.reportsSearch.cash);
                    if (!query) return this.cashRegisterHistory;
                    return this.cashRegisterHistory.filter(s => this.normalizeString(s.user).includes(query) || this.normalizeString(new Date(s.startTime).toLocaleString()).includes(query));
                },
                filteredEntryHistory() {
                    const query = this.normalizeString(this.reportsSearch.entries);
                    if (!query) return this.entryHistory;
                    return this.entryHistory.filter(e => this.normalizeString(e.productName).includes(query) || this.normalizeString(e.sku).includes(query) || this.normalizeString(e.user).includes(query));
                },
                filteredWastageHistory() {
                    const query = this.normalizeString(this.reportsSearch.wastage);
                    if (!query) return this.wastageHistory;
                    return this.wastageHistory.filter(w => this.normalizeString(w.productName).includes(query) || this.normalizeString(w.sku).includes(query) || this.normalizeString(w.user).includes(query));
                },
            },

watch: {
    // Watchers de funcionalidad (estos no cambian)
    searchQuery() { this.currentPage = 1; },
    filters: { handler() { this.currentPage = 1; }, deep: true },
    rowsPerPage() { this.currentPage = 1; },
    isFilterPopoverOpen(isOpen) { if (isOpen) { this.tempFilters = { ...this.filters }; } },
    selectedCustomerName(newName) { if (newName === 'Público en General' || !this.clients.find(c => `${c.firstName} ${c.lastName}` === newName)) { this.selectedClientId = null; } },

    // Watchers corregidos para solucionar el problema de los íconos
    mainView() {
        this.refreshIcons();
    },
    reportsView() {
        this.refreshIcons();
    },
    settingsView() {
        this.refreshIcons();
    },
    activeModal() {
        this.refreshIcons();
    },
    isSidebarCollapsed() {
        this.refreshIcons();
    }
},
            methods: {
                // Pega esto dentro de 'methods'
getCollectionRef(collectionName) {
    if (!this.mainUser) return null;
    return collection(db, 'businesses', this.mainUser.uid, collectionName);
},
                // General App & Helper Methods
                refreshIcons() { nextTick(() => { try { lucide.createIcons(); } catch(e) { /* ignore */ } }); },
                normalizeString(str) { return str ? str.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : ''; },
                formatCurrency(value) { return `$${Number(value || 0).toFixed(2)}`; },
                setView(viewName) { this.mainView = viewName; this.refreshIcons(); },
                
                // Modal & Overlay Management
openModal(modalName, data = {}) {
                    // --- ¡AQUÍ EMPIEZA LA NUEVA LÓGICA DE REINICIO! ---
                    // Antes de mostrar cualquier modal, reiniciamos los formularios asociados a ellos.
                    
                    if (modalName === 'stockAdjustment') {
                        // Reinicia el formulario de ajuste de stock a su estado inicial.
                        this.stockAdjustmentForm = { mode: 'entrada', quantity: null, note: '' };
                    }
                    if (modalName === 'clientForm') {
                        // Reinicia el formulario de cliente.
                        this.clientForm = data.client ? { ...data.client } : { id: null, firstName: '', lastName: '', email: '', phone: '', address: '', rnc: '', creditHistory: [] };
                    }
                     if (modalName === 'productForm') {
                        // Reinicia el formulario de producto.
                        this.productForm = data.product ? { ...data.product } : { name: '', sku: '', category: '', stock: 0, unit: 'Unidad', purchasePrice: 0, salePrice: 0, onOffer: false, offerPrice: null };
                    }
                    if (modalName === 'userForm') {
                        // Reinicia el formulario de usuario/perfil.
                         this.userForm = data.user ? { ...data.user } : { firstName: '', lastName: '', employeeCode: '', phone: '', position: '', permissions: ['dashboard', 'inventario'] };
                    }
                    if (modalName === 'kitForm') {
                        // Reinicia el formulario de kit.
                        this.kitComponentSearch = '';
                        this.kitForm = data.kit ? { name: data.kit.name, components: data.kit.components, salePrice: data.kit.salePrice } : { name: '', components: [], salePrice: 0 };
                    }

                    // --- Lógica original de la función ---
                    this.modalData = data;
                    this.activeModal = modalName;
                    this.refreshIcons();
                    
                    if (modalName === 'payment') { this.paymentStep = 'select'; this.paymentMethod = null; this.amountReceived = null; }
                    if (modalName === 'barcodeScanner') { this.scannerError = ''; this.scannedSku = ''; nextTick(() => this.$refs.skuInput?.focus()); }
                    if (modalName === 'barcode' && data.product) { nextTick(() => JsBarcode("#barcode", data.product.sku, { format: "CODE128", displayValue: true, fontSize: 18, textMargin: 0 })); }
                    if (modalName === 'productHistory' && data.product) { this.productHistory = data.product.history || []; }
                },
                                closeModal() { this.activeModal = null; this.modalData = {}; },
                showConfirmation(title, message, onConfirm) { this.openModal('confirm', { title, message, onConfirm }); },
                executeConfirm() { this.modalData.onConfirm(); this.closeModal(); },
                showNotification(title, message, type = 'info') { this.openModal('notification', { title, message, type }); },
                
                // Auth & User Profile Management
                getProfilesCollectionRef() { return this.mainUser ? collection(db, businessesCollectionPath, this.mainUser.uid, 'profiles') : null; },
resetForm() {
                    // Esta función ahora limpia todos los campos del objeto 'form'
                    this.form = { 
                        email: '', 
                        password: '', 
                        firstName: '', 
                        lastName: '', 
                        employeeCode: '', 
                        phone: '' 
                    };
                    this.authError = '';
                    this.isCreatingInitialProfile = false;
                },
                                async handleLogin() { this.isLoading = true; this.authError = ''; try { await signInWithEmailAndPassword(auth, this.form.email, this.form.password); } catch (error) { this.authError = "Correo o contraseña incorrectos."; } finally { this.isLoading = false; } },
                async handleRegister() {
                    this.isLoading = true;
                    this.authError = '';

                    // Lógica para crear el perfil de administrador por primera vez
                    if (this.isCreatingInitialProfile) {
                        try {
                            // --- ¡NUEVA VALIDACIÓN! ---
                            // 1. Validamos que los códigos coincidan.
                            if (this.form.employeeCode !== this.form.confirmEmployeeCode) {
                                this.authError = 'Los códigos de empleado no coinciden. Inténtalo de nuevo.';
                                this.isLoading = false;
                                return;
                            }
                            // 2. Validamos que el código tenga una longitud mínima.
                            if (this.form.employeeCode.length < 4) {
                                this.authError = 'El código debe tener al menos 4 caracteres.';
                                this.isLoading = false;
                                return;
                            }

                            // Usamos el código ingresado por el usuario en lugar de 'ADMIN01'
                            const profileData = {
                                firstName: this.form.firstName,
                                lastName: this.form.lastName,
                                phone: this.form.phone,
                                position: 'Administrador',
                                employeeCode: this.form.employeeCode, // <-- CÓDIGO PERSONALIZADO
                                permissions: this.allPermissions,
                                isBlocked: false,
                                createdAt: new Date(),
                                forceLogoutTimestamp: 0
                            };
                            await addDoc(collection(db, businessesCollectionPath, this.mainUser.uid, 'profiles'), profileData);
                            
                        } catch (error) {
                            this.authError = 'Error al crear el perfil de administrador.';
                        } finally {
                            this.isLoading = false;
                        }
                        return;
                    }

                    // Lógica original para crear la cuenta principal (esto no cambia)
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, this.form.email, this.form.password);
                        await setDoc(doc(db, businessesCollectionPath, userCredential.user.uid), {
                            ownerEmail: userCredential.user.email,
                            createdAt: new Date(),
                            appId: appId
                        });
                        // Ahora, en lugar de crear el perfil aquí, el sistema detectará que no hay perfiles
                        // y llevará al usuario al flujo de 'isCreatingInitialProfile' que acabamos de mejorar.
                    } catch (error) {
                        this.authError = error.code === 'auth/email-already-in-use' ? 'Este correo ya está en uso.' : 'Error al crear la cuenta.';
                    } finally {
                        this.isLoading = false;
                    }
                },
                async handlePasswordReset() { this.isLoading = true; this.authError = ''; try { await sendPasswordResetEmail(auth, this.form.email); this.showNotification('Enlace Enviado', 'Revisa tu bandeja de entrada para restablecer tu contraseña.', 'success'); this.authView = 'login'; } catch (error) { this.authError = 'No se pudo enviar el correo.'; } finally { this.isLoading = false; } },
               async handleLogout() {
                    await signOut(auth);
                    // AÑADIMOS ESTA LÍNEA: Llama a la función de reseteo para limpiar los campos
                    this.resetForm();
                },
                checkUserStatus(user) {
                    if (!user) { this.currentView = 'auth'; this.mainUser = null; this.employeeProfile = null; return; }
                    this.mainUser = user;
                    onSnapshot(this.getProfilesCollectionRef(), (snapshot) => {
                        this.employeeProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (snapshot.empty) {
                            this.currentView = 'auth'; this.authView = 'register'; this.isCreatingInitialProfile = true; this.form.email = user.email; this.authError = 'Para finalizar, completa tu perfil de administrador.';
                        } else if (this.currentView !== 'app') { this.currentView = 'profileLogin'; }
                    });
                },
             handleProfileLogin() {
                    this.authError = '';
                    const profile = this.employeeProfiles.find(p => this.normalizeString(p.firstName) === this.normalizeString(this.form.firstName) && p.employeeCode === this.form.employeeCode);

                    if (profile) {
                        // =================================================================
                        // ¡ESTA ES LA VERIFICACIÓN DE SEGURIDAD QUE FALTABA!
                        // Comprobamos si el perfil tiene la marca de 'isBlocked'.
                        // =================================================================
                        if (profile.isBlocked) {
                            this.authError = 'Este perfil ha sido bloqueado. Contacta a un administrador.';
                            return; // Detenemos el inicio de sesión aquí.
                        }
                        
                        // Si no está bloqueado, continuamos como siempre.
                        this.selectProfile(profile);
                    } else {
                        this.authError = 'Nombre o código de empleado incorrecto.';
                    }
                },
               // Reemplaza tu función 'selectProfile' existente con esta
async selectProfile(profile) {
                    this.employeeProfile = profile;
                    this.currentView = 'app';
                    
                    const viewOrder = ['dashboard', 'sales', 'inventory', 'returns', 'clients', 'reports', 'settings'];
                    const firstAllowedView = viewOrder.find(view => this.userHasPermission(view));

                    // --- ¡LÓGICA MEJORADA! ---
                    const firstView = firstAllowedView || 'sales';
                    
                    // Si la primera vista a la que debe ir es 'ventas', usamos nuestra función "guardia".
                    if (firstView === 'sales') {
                        this.goToSalesView(); 
                    } else {
                        // Para cualquier otra vista, vamos directamente.
                        this.setView(firstView);
                    }
                    
                    this.listenForProfileChanges();

                    // --- Carga de datos desde Firestore (esto se queda igual) ---
                    onSnapshot(this.getCollectionRef('products'), (snapshot) => {
                        this.allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.refreshIcons();
                    }, (error) => console.error("Error cargando productos: ", error));

                    onSnapshot(this.getCollectionRef('clients'), (snapshot) => {
                        this.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => console.error("Error cargando clientes: ", error));

                    onSnapshot(query(this.getCollectionRef('sales')), (snapshot) => {
                        this.salesHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    }, (error) => console.error("Error cargando ventas: ", error));

                    onSnapshot(query(this.getCollectionRef('returns')), (snapshot) => {
                        this.returnsHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    }, (error) => console.error("Error cargando devoluciones: ", error));
                    
                    onSnapshot(query(this.getCollectionRef('stock_entries')), (snapshot) => {
                        this.entryHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    }, (error) => console.error("Error cargando entradas: ", error));

                    onSnapshot(query(this.getCollectionRef('stock_wastage')), (snapshot) => {
                        this.wastageHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    }, (error) => console.error("Error cargando mermas: ", error));

                    onSnapshot(query(this.getCollectionRef('cashRegisterHistory')), (snapshot) => {
                        this.cashRegisterHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.endTime - a.endTime);
                    }, (error) => console.error("Error cargando historial de caja: ", error));

                    const businessInfoDocRef = doc(db, 'businesses', this.mainUser.uid, 'settings', 'businessInfo');
                    onSnapshot(businessInfoDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            this.businessInfo = docSnap.data();
                            this.businessInfoForm = { ...this.businessInfo };
                        }
                    }, (error) => console.error("Error cargando info del negocio: ", error));

                    if (this.userHasPermission('configuracion')) {
                        this.listenToUsers();
                    }
                    this.isCashRegisterOpen = false;
                    this.cashRegisterData = { initialAmount: 0, sales: [], refunds: [], startTime: null, closingAmount: null, endTime: null };
                },
              switchToProfileSelection() {
                    this.employeeProfile = null;
                    this.currentView = 'profileLogin';
                    this.resetForm();
                    this.isUserMenuOpen = false;
                    this.isCashRegisterOpen = false;
                    this.authError = ''; // Limpiamos cualquier mensaje de error previo
                },
                    listenForProfileChanges() {
                    if (!this.employeeProfile || !this.employeeProfile.id) return;

                    const docRef = doc(this.getCollectionRef('profiles'), this.employeeProfile.id);
                    onSnapshot(docRef, (docSnap) => {
                        if (!docSnap.exists()) {
                            this.showNotification('Perfil Eliminado', 'Tu perfil ha sido eliminado del sistema.');
                            this.handleLogout(); // Aquí sí cerramos sesión porque el perfil ya no existe
                            return;
                        }
                        
                        const updatedProfile = { id: docSnap.id, ...docSnap.data() };

                        // --- ¡LÓGICA MODIFICADA! ---
                        // ANTES: Si el timestamp cambiaba, cerraba la sesión completa (handleLogout).
                        // AHORA: Si el timestamp es nuevo, lo "expulsa" a la pantalla de selección de perfiles.
                        if (updatedProfile.forceLogoutTimestamp > (this.employeeProfile.forceLogoutTimestamp || 0)) {
                            // Usamos el campo de error existente para mostrar el mensaje en la pantalla de "Acceder Como"
                            this.authError = 'Un administrador ha bloqueado tu perfil. No puedes acceder.';
                            // Lo llevamos a la selección de perfiles, SIN CERRAR LA SESIÓN PRINCIPAL.
                            this.switchToProfileSelection(); 
                            return; 
                        }
                        
                        this.employeeProfile = updatedProfile;
                    });
                },                listenToUsers() { onSnapshot(this.getProfilesCollectionRef(), (snapshot) => { this.userList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }); },
                userHasPermission(permission) { return this.employeeProfile?.permissions?.includes(permission); },
                
                // Admin Confirmation Flow
                requestAdminAuth(title, message, onSuccess) {
                    this.adminConfirm.onSuccess = onSuccess;
                    this.adminConfirm.error = '';
                    this.adminConfirm.form = { firstName: '', employeeCode: '' };
                    this.openModal('adminConfirm', { title, message });
                },
                handleAdminAuthConfirm() {
                    this.isLoading = true;
                    this.adminConfirm.error = '';

                    const authorizedUser = this.employeeProfiles.find(p =>
                        this.normalizeString(p.firstName) === this.normalizeString(this.adminConfirm.form.firstName) &&
                        p.employeeCode === this.adminConfirm.form.employeeCode
                    );

                    // --- ¡LÓGICA MODIFICADA! ---
                    // Ahora verificamos si el usuario existe Y si tiene CUALQUIERA de los dos permisos.
                    if (authorizedUser && (authorizedUser.permissions.includes('configuracion') || authorizedUser.permissions.includes('aplicar_descuento'))) {
                        this.closeModal();
                        this.adminConfirm.onSuccess();
                    } else {
                        // Mensaje de error más general
                        this.adminConfirm.error = 'Credenciales incorrectas o sin permiso para aplicar descuentos.';
                    }
                    this.isLoading = false;
                },
                
                // CRUD Forms (User, Product, Client, Business)
    openUserFormModal(user = null, requiresAuth = false) {
    const openAction = () => {
        if (user) {
            // --- LÓGICA CORREGIDA PARA EDITAR ---
            // A. Guardamos el ID del perfil en nuestra variable segura.
            this.editingUserId = user.id; 
            // B. Llenamos el formulario con los datos del perfil.
            this.userForm = { ...user };
        } else {
            // --- LÓGICA PARA CREAR UN NUEVO PERFIL ---
            // A. Nos aseguramos de que no haya ningún ID guardado.
            this.editingUserId = null;
            // B. Limpiamos el formulario.
            this.userForm = { firstName: '', lastName: '', employeeCode: '', phone: '', position: '', permissions: ['dashboard', 'inventario'] };
        }
        this.openModal('userForm', { isEditing: !!user });
    };
    
    if (requiresAuth) { 
        this.requestAdminAuth('Confirmación de Administrador', 'Para crear un nuevo perfil, ingresa las credenciales de un administrador.', openAction); 
    } else { 
        openAction(); 
    }
},
    async handleSaveUser() {
    if (!this.userForm.firstName || !this.userForm.lastName || !this.userForm.employeeCode) {
        this.showNotification('Error de Validación', 'Nombre, Apellido y Código son campos obligatorios.');
        return;
    }

    this.isLoading = true;
    try {
        // Copiamos los datos del formulario, excluyendo cualquier ID que pudiera tener.
        const { id, ...dataToSave } = this.userForm;

        // La lógica ahora depende de nuestra variable segura `editingUserId`.
        if (this.editingUserId) {
            // --- LÓGICA DE EDICIÓN MÁS ROBUSTA ---
            // Apuntamos al documento correcto usando el ID guardado.
            const userRef = doc(this.getCollectionRef('profiles'), this.editingUserId);
            await updateDoc(userRef, dataToSave);
        } else {
            // --- LÓGICA DE CREACIÓN (sin cambios) ---
            const newProfileData = {
                ...dataToSave,
                isBlocked: false,
                createdAt: new Date(),
                forceLogoutTimestamp: 0
            };
            await addDoc(this.getCollectionRef('profiles'), newProfileData);
        }
        
        this.closeModal();
        this.showNotification('Éxito', 'El perfil se guardó correctamente.', 'success');

    } catch (error) {
        console.error("Error guardando perfil:", error);
        this.showNotification('Error', 'No se pudo guardar el perfil. Revisa la consola para más detalles.');
    } finally {
        this.isLoading = false;
        // Al finalizar, limpiamos nuestra variable segura.
        this.editingUserId = null; 
    }
},

                openProductFormModal(product = null) {
    // Primero, verificamos si es un Kit para usar su propio modal.
    if (product?.isKit) { 
        this.openKitFormModal(product); 
        return; 
    }
    
    // MODO EDICIÓN: Si recibimos un producto al llamar la función...
    if (product) {
        // ¡CLAVE! Guardamos el ID del producto en un lugar seguro y separado.
        this.editingProductId = product.id;
        
        // ¡CLAVE! Llenamos la variable 'productForm' con una copia de los datos del producto.
        // Como el modal está conectado a 'productForm', ESTO HACE QUE SE LLENE AUTOMÁTICAMENTE.
        this.productForm = { ...product };

    } else {
        // MODO CREACIÓN: Si no recibimos producto (cuando presionas 'Añadir Producto')...
        // Nos aseguramos de que no haya un ID viejo guardado.
        this.editingProductId = null;

        // Dejamos el formulario vacío para que puedas crear un producto nuevo.
        this.productForm = { name: '', sku: '', category: '', stock: 0, unit: 'Unidad', purchasePrice: 0, salePrice: 0, onOffer: false, offerPrice: null, history: [] };
    }
    
    // Finalmente, abrimos el modal y le decimos que estamos en modo de edición (si aplica).
    this.openModal('productForm', { isEditing: !!product });
},
                 async handleAddOrUpdateProduct() {
    // Validaciones (esto se queda igual)
    if (!this.productForm.name) { this.showNotification('Error', 'El nombre del producto es obligatorio.'); return; }
    if (this.productForm.onOffer && (!this.productForm.offerPrice || this.productForm.offerPrice <= 0)) { this.showNotification('Error', 'El precio de oferta debe ser un número positivo.'); return; }
    
    this.isLoading = true;
    if (!this.productForm.onOffer) { this.productForm.offerPrice = null; }

    try {
        // ¡CLAVE! Verificamos si estamos en modo EDICIÓN usando nuestra variable segura.
        if (this.editingProductId) {
            // MODO EDICIÓN
            // Excluimos el 'id' del objeto que se va a guardar, por limpieza.
            const { id, ...dataToUpdate } = this.productForm; 

            // Apuntamos al documento correcto en la base de datos usando el ID guardado.
            const productRef = doc(this.getCollectionRef('products'), this.editingProductId);

            // Actualizamos el documento con la nueva información del formulario.
            await updateDoc(productRef, dataToUpdate);
        } else {
            // MODO CREACIÓN (esta parte no cambia)
            if (!this.productForm.sku) { this.productForm.sku = `SKU-${Date.now()}`; }
            const newProduct = { ...this.productForm, isKit: false, createdAt: Date.now() };
            delete newProduct.history;
            await addDoc(this.getCollectionRef('products'), newProduct);
        }

        this.showNotification('Éxito', 'Producto guardado correctamente.', 'success');
        this.closeModal();

    } catch (error) {
        console.error("Error guardando producto: ", error);
        this.showNotification('Error', 'No se pudo guardar el producto.');
    } finally {
        this.isLoading = false;
        // Buena práctica: Limpiamos el ID al terminar la operación.
        this.editingProductId = null;
    }
},

                openClientFormModal(client = null) {
                    this.clientForm = client ? { ...client } : { id: null, firstName: '', lastName: '', email: '', phone: '', address: '', rnc: '', creditHistory: [] };
                    this.openModal('clientForm', { isEditing: !!client });
                },
async handleSaveClient() {
                    if (!this.clientForm.firstName || !this.clientForm.lastName) { this.showNotification('Error', 'El nombre y el apellido son obligatorios.'); return; }
                    this.isLoading = true;
                    try {
                        const isEditing = this.modalData.isEditing;
                        if (isEditing) {
                            const { id, ...dataToUpdate } = this.clientForm;
                            await updateDoc(doc(this.getCollectionRef('clients'), id), dataToUpdate);
                        } else {
                            const newClient = { ...this.clientForm, createdAt: Date.now() };
                            delete newClient.id; // Firestore manejará el ID
                            await addDoc(this.getCollectionRef('clients'), newClient);
                        }
                        this.showNotification('Éxito', 'Cliente guardado correctamente.', 'success');
                        this.closeModal();
                    } catch (error) {
                        console.error("Error guardando cliente:", error);
                        this.showNotification('Error', 'No se pudo guardar el cliente.');
                    } finally {
                        this.isLoading = false;
                    }
                },          async handleSaveBusinessInfo() {
                    this.isLoading = true;
                    try {
                        const docRef = doc(db, 'businesses', this.mainUser.uid, 'settings', 'businessInfo');
                        await setDoc(docRef, this.businessInfoForm, { merge: true }); // setDoc con merge crea el doc si no existe, o lo actualiza si ya existe
                        this.showNotification('Éxito', 'La información del negocio ha sido actualizada.', 'success');
                    } catch (error) {
                        console.error("Error guardando información del negocio:", error);
                        this.showNotification('Error', 'No se pudo guardar la información.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                // Inventory & Table Management
                getProductStatus(stock) { if (stock === 0) return { text: 'Agotado', class: 'bg-red-100 text-red-800' }; if (stock < 10) return { text: 'Bajo Stock', class: 'bg-yellow-100 text-yellow-800' }; return { text: 'En Stock', class: 'bg-green-100 text-green-800' }; },
                copyToClipboard(text, fieldName = 'Texto') { const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); this.showNotification('Copiado', `¡${fieldName} copiado al portapapeles!`, 'success'); } catch (err) { this.showNotification('Error', 'No se pudo copiar el texto.'); } document.body.removeChild(ta); },
                startResize(event, index) { this.resizingIndex = index; this.resizingStartX = event.clientX; this.resizingStartWidth = this.$refs.inventoryTable.querySelectorAll('th')[index].offsetWidth; document.addEventListener('mousemove', this.doResize); document.addEventListener('mouseup', this.stopResize); },
                doResize(event) { if (this.resizingIndex === null) return; const newWidth = this.resizingStartWidth + (event.clientX - this.resizingStartX); if (newWidth > 50) { this.tableHeaders[this.resizingIndex].width = `${newWidth}px`; } },
                stopResize() { this.resizingIndex = null; document.removeEventListener('mousemove', this.doResize); document.removeEventListener('mouseup', this.stopResize); },
                toggleDropdown(Id) { this.activeDropdownId = this.activeDropdownId === Id ? null : Id; },
                closeAllDropdowns(event) {
                    if (this.activeDropdownId && !event.target.closest('.actions-cell')) this.activeDropdownId = null;
                    if (this.isFilterPopoverOpen && this.$refs.filterContainer && !this.$refs.filterContainer.contains(event.target)) this.isFilterPopoverOpen = false;
                    if (this.isUserMenuOpen && this.$refs.userMenuContainer && !this.$refs.userMenuContainer.contains(event.target)) this.isUserMenuOpen = false;
                    if (this.isDiscountPopoverOpen && this.$refs.discountPopover && !this.$refs.discountPopover.contains(event.target) && !event.target.closest('[data-discount-toggle]')) this.isDiscountPopoverOpen = false;
                    if (this.isDiscountTypeSelectorOpen && this.$refs.discountTypeSelectorContainer && !this.$refs.discountTypeSelectorContainer.contains(event.target)) this.isDiscountTypeSelectorOpen = false;
                    if (this.showClientSuggestions && !event.target.closest('.relative')) this.showClientSuggestions = false;
                },
                applyFilters() { this.filters = { ...this.tempFilters }; this.isFilterPopoverOpen = false; },
                clearAndApplyFilters() { this.tempFilters = { category: 'all', status: 'all' }; this.applyFilters(); },
                nextPage() { if (this.currentPage < this.totalPages) this.currentPage++; },
                prevPage() { if (this.currentPage > 1) this.currentPage--; },
                goToPage(page) { this.currentPage = page; },
                toggleSelectAllProducts() {
                    if (this.areAllProductsSelected) {
                        this.selectedProducts = [];
                    } else {
                        this.selectedProducts = this.filteredProducts.map(p => p.sku);
                    }
                },
                handleDeleteSelected() { const count = this.selectedProducts.length; this.showConfirmation('Confirmar Eliminación', `¿Seguro que quieres eliminar <strong>${count}</strong> producto(s)?`, () => { this.allProducts = this.allProducts.filter(p => !this.selectedProducts.includes(p.sku)); this.selectedProducts = []; this.showNotification('Eliminados', `${count} producto(s) han sido eliminados.`, 'success'); }); },
   handleDeleteProduct(product) {
                    this.showConfirmation('Confirmar Eliminación', `¿Seguro que quieres eliminar <strong>${product.name}</strong>? Esta acción no se puede deshacer.`, async () => {
                        try {
                            await deleteDoc(doc(this.getCollectionRef('products'), product.id));
                            this.showNotification('Eliminado', `El producto ${product.name} ha sido eliminado.`, 'success');
                        } catch (error) {
                            console.error("Error eliminando producto:", error);
                            this.showNotification('Error', 'No se pudo eliminar el producto.');
                        }
                    });
                },
                handleExportSelected() {
                    if (this.selectedProducts.length === 0) { this.showNotification('Sin selección', 'Por favor, selecciona al menos un producto para exportar.'); return; }
                    const productsToExport = this.allProducts.filter(p => this.selectedProducts.includes(p.sku));
                    const headers = ['SKU', 'Nombre', 'Categoría', 'PrecioCompra', 'PrecioVenta', 'Stock', 'Unidad'];
                    const csvRows = [headers.join(',')];
                    
                    productsToExport.forEach(p => {
                        const row = [p.sku, `"${p.name}"`, p.category, p.purchasePrice, p.salePrice, p.stock, p.unit];
                        csvRows.push(row.join(','));
                    });

                    const csvString = csvRows.join('\n');
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                },
                handleCopySelected() {
                    if (this.selectedProducts.length === 0) { this.showNotification('Sin selección', 'Por favor, selecciona al menos un producto para copiar.'); return; }
                    const productsToCopy = this.allProducts.filter(p => this.selectedProducts.includes(p.sku));
                    const headers = ['SKU', 'Nombre', 'Categoría', 'P. Venta', 'Stock'];
                    let textToCopy = headers.join('\t') + '\n'; // Use tabs for easy pasting into Excel/Sheets
                    
                    productsToCopy.forEach(p => {
                        const row = [p.sku, p.name, p.category, this.formatCurrency(p.salePrice), p.stock];
                        textToCopy += row.join('\t') + '\n';
                    });

                    this.copyToClipboard(textToCopy, `${productsToCopy.length} producto(s)`);
                },
async handleStockAdjustment() {
                    const { product } = this.modalData;
                    const { mode, quantity, note } = this.stockAdjustmentForm;
                    if (!quantity || quantity <= 0) { this.showNotification('Error', 'Ingresa una cantidad válida.'); return; }

                    this.isLoading = true;
                    try {
                        const productRef = doc(this.getCollectionRef('products'), product.id);
                        const quantityChange = mode === 'entrada' ? quantity : -quantity;
                        
                        // Actualizar el stock del producto
                        const newStock = (product.stock || 0) + quantityChange;
                        await updateDoc(productRef, { stock: newStock });

                        // Crear registro en la colección de historial correspondiente
                        const historyRecord = { 
                            sku: product.sku, productName: product.name, user: this.employeeProfile.firstName, 
                            note, quantity, timestamp: Date.now(),
                            purchasePrice: product.purchasePrice || 0,
                            totalValue: (product.purchasePrice || 0) * quantity
                        };

                        if (mode === 'entrada') {
                            await addDoc(this.getCollectionRef('stock_entries'), historyRecord);
                        } else {
                            await addDoc(this.getCollectionRef('stock_wastage'), historyRecord);
                        }
                        
                        this.showNotification('Éxito', `Stock de ${product.name} ajustado.`, 'success');
                        this.closeModal();
                    } catch (error) {
                        console.error("Error ajustando stock:", error);
                        this.showNotification('Error', 'No se pudo ajustar el stock.');
                    } finally {
                        this.isLoading = false;
                    }
                },
                confirmDeleteHistoryItem(itemToDelete) { this.showConfirmation('Eliminar Registro', `¿Seguro que quieres eliminar este registro?`, () => { this.productHistory = this.productHistory.filter(item => item.id !== itemToDelete.id); this.showNotification('Registro Eliminado', '', 'success'); }); },
                confirmDeleteAllHistory() { if (this.productHistory.length === 0) { this.showNotification('Historial Vacío'); return; } this.showConfirmation('Eliminar Todo el Historial', `¿Seguro que quieres eliminar <strong>todos los ${this.productHistory.length} registros</strong>?`, () => { this.productHistory = []; this.showNotification('Historial Eliminado', '', 'success'); }); },
                
                // Reports -> Product Info
                openProductInfoModal(historyItem) {
                    this.isLoading = true;
                    this.openModal('productInfo', {});
                    const productDetails = this.allProducts.find(p => p.sku === historyItem.sku);
                    this.isLoading = false;
                    if (productDetails) {
                        this.modalData.product = productDetails;
                        this.refreshIcons();
                    } else {
                        this.closeModal();
                        this.showNotification('Error', 'No se pudieron cargar los detalles del producto.', 'error');
                    }
                },

                // Kit Management
                openKitFormModal(kit = null) {
                    this.kitComponentSearch = '';
                    if (kit) {
                        const components = kit.components.map(c => ({ ...this.allProducts.find(p => p.sku === c.sku), quantity: c.quantity }));
                        this.kitForm = { name: kit.name, components, salePrice: kit.salePrice };
                    } else {
                        this.kitForm = { name: '', components: [], salePrice: 0 };
                    }
                    this.openModal('kitForm', { isEditing: !!kit, kit });
                },
                addProductToKit(product) { const existing = this.kitForm.components.find(c => c.sku === product.sku); if (existing) existing.quantity++; else this.kitForm.components.push({ ...product, quantity: 1 }); },
                removeProductFromKit(index) { this.kitForm.components.splice(index, 1); },
                handleSaveKit() {
                    if (!this.kitForm.name.trim() || this.kitForm.components.length === 0 || !this.kitForm.salePrice || this.kitForm.salePrice <= 0) { this.showNotification('Error', 'Completa todos los campos del kit.'); return; }
                    
                    const newKit = {
                        name: this.kitForm.name,
                        sku: `KIT-${Date.now()}`,
                        category: 'Kit',
                        purchasePrice: this.kitTotalCost,
                        salePrice: this.kitForm.salePrice,
                        stock: this.maxKitStock,
                        unit: 'Unidad',
                        isKit: true,
                        components: this.kitForm.components.map(c => ({ sku: c.sku, quantity: c.quantity })),
                        history: []
                    };
                    
                    this.allProducts.unshift(newKit);
                    this.showNotification('Éxito', `Kit guardado.`, 'success');
                    this.closeModal();
                },
                calculateKitStock(kit) {
                    if (!kit.isKit || !kit.components) return 0;
                    const stockLimits = kit.components.map(c => { const p = this.allProducts.find(prod => prod.sku === c.sku); return (!p || !c.quantity) ? Infinity : Math.floor(p.stock / c.quantity); });
                    return Math.min(...stockLimits);
                },

                // Sales, Cart & Payment Flow
               goToSalesView() {
                    // Este es el "guardia": si la caja está abierta, va a ventas.
                    // Si no, lo obliga a ir a la pantalla de apertura de caja.
                    if (this.isCashRegisterOpen) {
                        this.setView('sales');
                    } else {
                        this.setView('openRegister');
                    }
                },
                addToCart(product) {
                    if (!this.isCashRegisterOpen) { this.goToSalesView(); return; }
                    let stock = product.isKit ? this.calculateKitStock(product) : product.stock;
                    if (stock === 0) { this.showNotification('Sin Stock', 'Este producto está agotado.'); return; }
                    const item = this.cart.find(i => i.sku === product.sku);
                    if (item) { if (item.quantity < stock) item.quantity++; else this.showNotification('Límite de Stock', 'No puedes añadir más unidades.'); } 
                    else { this.cart.push({ sku: product.sku, name: product.name, price: product.offerPrice || product.salePrice, quantity: 1, isKit: product.isKit || false, components: product.components || [] }); }
                },
                removeFromCart(index) { this.cart.splice(index, 1); },
                updateCartQuantity(index, change) {
                    const item = this.cart[index]; const newQty = item.quantity + change;
                    if (newQty < 1) return;
                    item.quantity = newQty;
                },
                validateCartQuantity(index) {
                    const item = this.cart[index];
                    if (!item.quantity || isNaN(item.quantity) || item.quantity < 1) { item.quantity = 1; return; }
                    item.quantity = Math.floor(item.quantity);
                },
                openDiscountPopoverWithAdminCheck() {
                    this.requestAdminAuth(
                        'Autorización Requerida',
                        'Para aplicar un descuento, ingresa las credenciales de un usuario autorizado.',
                        () => { this.isDiscountPopoverOpen = true; }
                    );
                },
                selectDiscountType(type) { this.discountType = type; this.isDiscountTypeSelectorOpen = false; this.discountValue = 0; },
                handleParkSale() { if (this.cart.length === 0) return; this.parkedSales.push([...this.cart]); this.cart = []; this.showNotification('Venta Aparcada', 'El carrito actual ha sido guardado.', 'success'); },
                getParkedSaleTotal(sale) { return sale.reduce((total, item) => total + (item.price * item.quantity), 0); },
                restoreParkedSale(index) { if (this.cart.length > 0) { this.showNotification('Carrito Ocupado', 'Finalice o aparque la venta actual primero.'); return; } this.cart = this.parkedSales[index]; this.parkedSales.splice(index, 1); this.closeModal(); this.showNotification('Venta Restaurada', 'La venta ha sido cargada en el carrito.', 'success'); },
                handleScannedSku() {
                    this.scannerError = ''; const sku = this.scannedSku.trim(); if (!sku) { this.scannerError = 'Ingrese un código.'; return; }
                    const product = this.allProducts.find(p => p.sku === sku);
                    if (product) {
                        this.addToCart(product);
                        this.scannedSku = '';
                        this.closeModal();
                    } else {
                        this.scannerError = 'Producto no encontrado.';
                    }
                },
                selectPaymentMethod(method) {
                    this.paymentMethod = method;
                    if (method === 'Crédito') { this.processFinalSale(); } 
                    else { this.paymentStep = 'input'; if (method !== 'Efectivo') this.amountReceived = this.cartTotal; }
                },
                goBackToPaymentSelection() { this.paymentStep = 'select'; this.paymentMethod = null; this.amountReceived = null; },
// Reemplaza de nuevo la función processFinalSale completa con esta versión corregida
                async processFinalSale() {
                    if (this.cart.length === 0) return;
                    this.isLoading = true;

                    try {
                        const batch = writeBatch(db);

                        // 1. Descontar el stock de cada producto en el carrito
                        for (const item of this.cart) {
                            if (item.isKit) {
                                // Si es un kit, descontar el stock de sus componentes
                                for (const component of item.components) {
                                    const productDoc = this.allProducts.find(p => p.sku === component.sku);
                                    if (productDoc) {
                                        const productRef = doc(this.getCollectionRef('products'), productDoc.id);
                                        const stockToDecrease = item.quantity * component.quantity;
                                        const newStock = (productDoc.stock || 0) - stockToDecrease;
                                        batch.update(productRef, { stock: newStock });
                                    }
                                }
                            } else {
                                // Si es un producto normal
                                const productDoc = this.allProducts.find(p => p.sku === item.sku);
                                if (productDoc) {
                                    const productRef = doc(this.getCollectionRef('products'), productDoc.id);
                                    const newStock = (productDoc.stock || 0) - item.quantity;
                                    batch.update(productRef, { stock: newStock });
                                }
                            }
                        }

                        // 2. Preparar el objeto de la factura/venta
                        let payments = [], change = 0, amountReceived = 0;
                        if (this.paymentMethod === 'Efectivo') {
                            amountReceived = this.amountReceived;
                            change = amountReceived - this.cartTotal;
                        }
                        payments.push({ method: this.paymentMethod, amount: this.cartTotal });
                        
                        const invoice = {
                            date: new Date().toLocaleString('es-DO'),
                            timestamp: Date.now(),
                            invoiceNumber: `VENTA-${Date.now()}`,
                            client: this.selectedCustomerName,
                            cashier: `${this.employeeProfile.firstName}`,
                            items: [...this.cart],
                            subtotal: this.cartSubtotal,
                            discount: this.discountAmount,
                            tax: this.taxAmount,
                            total: this.cartTotal,
                            payments, change, amountReceived
                        };
                        
                        // 3. Añadir la venta a su colección (LÍNEA CORREGIDA)
                        const saleRef = doc(this.getCollectionRef('sales')); // Se eliminó el "collection()" extra
                        batch.set(saleRef, invoice);

                        // 4. Si es a crédito, actualizar el historial del cliente
                        if (this.paymentMethod === 'Crédito') {
                             const clientDoc = this.clients.find(c => c.id === this.selectedClientId);
                             if (clientDoc) {
                                const clientRef = doc(this.getCollectionRef('clients'), clientDoc.id);
                                const newTransaction = { id: Date.now(), type: 'cargo', amount: this.cartTotal, note: `Venta #${invoice.invoiceNumber}`, timestamp: Date.now() };
                                const updatedHistory = [...(clientDoc.creditHistory || []), newTransaction];
                                batch.update(clientRef, { creditHistory: updatedHistory });
                             }
                        }

                        // 5. Ejecutar todas las operaciones en la base de datos
                        await batch.commit();

                        // 6. Registrar en la caja (si está abierta)
                        this.cashRegisterData.sales.push({ total: this.cartTotal, payments, timestamp: Date.now() });
                        
                        this.closeModal();
                        this.openModal('invoice', { invoice });

                    } catch (error) {
                        console.error("Error procesando la venta: ", error);
                        this.showNotification('Error Crítico', 'No se pudo procesar la venta. El stock no ha sido modificado.');
                    } finally {
                        this.isLoading = false;
                    }
                },                closeInvoiceModal() { this.closeModal(); this.cart = []; this.discountValue = 0; this.selectedClientId = null; this.selectedCustomerName = 'Público en General'; },
                printInvoice() {
                    const printContents = document.getElementById('receipt-print-area').innerHTML;
                    const printWindow = window.open('', '_blank', 'height=800,width=320');
                    if (printWindow) {
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html lang="es"><head><title>Factura</title>
                            <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                            <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Source Code Pro', monospace; color: #000; }
                                body { width: 76mm; font-size: 10pt; line-height: 1.4; } .receipt-container { padding: 2mm; }
                                .text-center { text-align: center; } .mb-2 { margin-bottom: 8px; } .mb-4 { margin-bottom: 16px; } .font-bold { font-weight: 600; }
                                .text-lg { font-size: 14pt; } .text-xs { font-size: 8pt; } .border-t { border-top: 1px dashed #000; }
                                .border-b { border-bottom: 1px dashed #000; } .my-2 { margin-top: 8px; margin-bottom: 8px; }
                                .py-1 { padding-top: 4px; padding-bottom: 4px; } .pt-1 { padding-top: 4px; }
                                table { width: 100%; border-collapse: collapse; } th, td { padding: 3px 0; vertical-align: top; }
                                th { border-bottom: 1px solid #000; text-align: left; } .text-right { text-align: right; }
                                .text-gray-600 { color: #555; } .summary-line { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
                                .mt-1 { margin-top: 4px; } .mt-4 { margin-top: 16px; } strong { font-weight: 600; }
                                .max-h-20 { max-height: 5rem; } .mx-auto { margin-left: auto; margin-right: auto; }
                                .whitespace-pre-wrap { white-space: pre-wrap; }
                                @media print { @page { size: 80mm auto; margin: 0; } body { width: 100%; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
                            </style></head><body><div class="receipt-container">${printContents}</div></body></html>`);
                        printWindow.document.close();
                        setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
                    } else { this.showNotification('Error de Impresión', 'No se pudo abrir la ventana de impresión. Revisa si tu navegador está bloqueando las ventanas emergentes.'); }
                },

                // Cash Register Flow
                handleOpenRegister() {
                    if(this.initialAmountForm === null || this.initialAmountForm < 0) { this.showNotification('Error', 'Ingresa un monto inicial válido.'); return; }
                    this.isCashRegisterOpen = true;
                    this.cashRegisterData = { initialAmount: this.initialAmountForm, sales: [], refunds: [], startTime: Date.now(), closingAmount: null, endTime: null };
                    this.closeModal(); this.goToSalesView(); this.showNotification('Caja Abierta', 'El turno ha comenzado.', 'success');
                },
                handleCloseRegister() {
                    if(this.closingAmountForm === null || this.closingAmountForm < 0) { this.showNotification('Error', 'Ingresa el monto contado en caja.'); return; }
                    this.cashRegisterData.closingAmount = this.closingAmountForm; this.cashRegisterData.endTime = Date.now();
                },
                finalizeAndResetRegister() {
                    const sessionData = { 
                        id: `CR-${Date.now()}`, user: this.employeeProfile.firstName, startTime: this.cashRegisterData.startTime, endTime: this.cashRegisterData.endTime,
                        initialAmount: this.cashRegisterData.initialAmount, closingAmount: this.cashRegisterData.closingAmount, expectedCash: this.expectedCashInRegister,
                        difference: this.cashDifference, sales: this.cashRegisterData.sales, refunds: this.cashRegisterData.refunds
                    };
                    this.cashRegisterHistory.unshift(sessionData);
                    this.isCashRegisterOpen = false; this.cashRegisterData = { initialAmount: 0, sales: [], refunds: [], startTime: null, closingAmount: null, endTime: null };
                    this.initialAmountForm = null; this.closingAmountForm = null; this.closeModal(); this.goToSalesView();
                },

                // Returns Flow
                handleFindInvoice() {
                    const invoice = this.salesHistory.find(s => s.invoiceNumber === this.returnsInvoiceSearch);
                    if (invoice) {
                        this.foundInvoice = invoice;
                        this.itemsToReturn = JSON.parse(JSON.stringify(invoice.items)).map(item => ({ ...item, isReturning: false, returnQuantity: item.quantity }));
                    } else {
                        this.showNotification('Factura no encontrada', 'No se encontró ninguna venta con ese número de factura.');
                        this.foundInvoice = null; this.itemsToReturn = [];
                    }
                },
                handleConfirmReturn() {
                    const returnedItems = this.itemsToReturn.filter(i => i.isReturning && i.returnQuantity > 0);
                    if (returnedItems.length === 0) { this.showNotification('Error', 'No has seleccionado ningún producto para devolver.'); return; }
                    
                    // Actualizar stock de productos devueltos
                    returnedItems.forEach(item => {
                        const productIndex = this.allProducts.findIndex(p => p.sku === item.sku);
                        if (productIndex !== -1) {
                            this.allProducts[productIndex].stock += item.returnQuantity;
                        }
                    });

                    const returnRecord = {
                        id: `DEV-${Date.now()}`, timestamp: Date.now(), originalInvoiceNumber: this.foundInvoice.invoiceNumber,
                        returnedItems: returnedItems, totalRefund: this.totalRefundAmount, reason: this.returnForm.reason,
                        refundMethod: this.returnForm.refundMethod, user: this.employeeProfile.firstName,
                    };
                    this.returnsHistory.unshift(returnRecord);
                    if (this.returnForm.refundMethod === 'Efectivo' && this.isCashRegisterOpen) { this.cashRegisterData.refunds.push(returnRecord); }
                    this.showNotification('Devolución Exitosa', 'La devolución ha sido procesada correctamente.', 'success');
                    this.closeModal(); this.foundInvoice = null; this.itemsToReturn = []; this.returnsInvoiceSearch = ''; this.returnForm = { reason: '', refundMethod: 'Efectivo' };
                },

                // Client & Credit Management
                confirmDeleteClient(client) { this.showConfirmation('Eliminar Cliente', `¿Seguro que quieres eliminar a <strong>${client.firstName} ${client.lastName}</strong>?`, () => { this.clients = this.clients.filter(c => c.id !== client.id); this.showNotification('Cliente Eliminado', '', 'success'); }); },
                getClientBalance(client) { const balance = client?.creditHistory.reduce((acc, tx) => tx.type === 'cargo' ? acc + tx.amount : acc - tx.amount, 0) || 0; return { raw: balance, formatted: this.formatCurrency(balance), class: balance > 0 ? 'text-red-600' : 'text-green-800' }; },
                selectClient(client) { this.selectedClientId = client.id; this.selectedCustomerName = `${client.firstName} ${client.lastName}`; this.showClientSuggestions = false; },
                handleAddCreditTransaction() {
                    const { amount, type, note } = this.creditForm;
                    if (!amount || amount <= 0) { this.showNotification('Error', 'Ingresa un monto válido.'); return; }
                    const clientIndex = this.clients.findIndex(c => c.id === this.modalData.client.id);
                    if (clientIndex !== -1) { this.clients[clientIndex].creditHistory.push({ id: Date.now(), type, amount, note: note || (type === 'abono' ? 'Abono manual' : 'Cargo manual'), timestamp: Date.now() }); }
                    this.creditForm = { type: 'abono', amount: null, note: '' };
                }, 
                async handleSaveBusinessInfo() {
                    this.isLoading = true;
                    try {
                        // La ruta al documento de configuración es fija
                        const docRef = doc(db, 'businesses', this.mainUser.uid, 'settings', 'businessInfo');
                        // setDoc con merge crea o sobreescribe el documento con los nuevos datos del formulario
                        await setDoc(docRef, this.businessInfoForm, { merge: true }); 
                        this.showNotification('Éxito', 'La información del negocio ha sido actualizada.', 'success');
                    } catch (error) {
                        console.error("Error guardando información del negocio:", error);
                        this.showNotification('Error', 'No se pudo guardar la información.');
                    } finally {
                        this.isLoading = false;
                    }
                }, async finalizeAndResetRegister() {
                    const sessionData = { 
                        user: this.employeeProfile.firstName, 
                        startTime: this.cashRegisterData.startTime, 
                        endTime: this.cashRegisterData.endTime,
                        initialAmount: this.cashRegisterData.initialAmount, 
                        closingAmount: this.cashRegisterData.closingAmount, 
                        expectedCash: this.expectedCashInRegister,
                        difference: this.cashDifference, 
                        sales: this.cashRegisterData.sales, 
                        refunds: this.cashRegisterData.refunds
                    };
                    
                    try {
                        // Añadimos el resumen de la sesión a la colección en Firestore
                        await addDoc(this.getCollectionRef('cashRegisterHistory'), sessionData);
                        
                        // Reseteamos el estado local
                        this.isCashRegisterOpen = false; 
                        this.cashRegisterData = { initialAmount: 0, sales: [], refunds: [], startTime: null, closingAmount: null, endTime: null };
                        this.initialAmountForm = null; 
                        this.closingAmountForm = null; 
                        this.closeModal(); 
                        this.goToSalesView();
                        this.showNotification('Caja Finalizada', 'El resumen del turno ha sido guardado.', 'success');
                    } catch(error) {
                        console.error("Error guardando el cierre de caja:", error);
                        this.showNotification('Error', 'No se pudo guardar el registro del cierre de caja.');
                    }
                }, async handleConfirmReturn() {
                    const itemsBeingReturned = this.itemsToReturn.filter(i => i.isReturning && i.returnQuantity > 0);
                    if (itemsBeingReturned.length === 0) { this.showNotification('Error', 'No has seleccionado ningún producto para devolver.'); return; }

                    this.isLoading = true;
                    try {
                        const batch = writeBatch(db);

                        // Mapeamos los items devueltos para añadirles el costo (precio de compra)
                        const returnedItemsWithCost = itemsBeingReturned.map(item => {
                            const originalProduct = this.allProducts.find(p => p.sku === item.sku);
                            return {
                                ...item,
                                purchasePrice: originalProduct ? originalProduct.purchasePrice : 0
                            };
                        });

                        // 1. Actualizar el stock de productos devueltos
                        returnedItemsWithCost.forEach(item => {
                            const productDoc = this.allProducts.find(p => p.sku === item.sku);
                            if(productDoc) {
                                const productRef = doc(this.getCollectionRef('products'), productDoc.id);
                                const newStock = productDoc.stock + item.returnQuantity;
                                batch.update(productRef, { stock: newStock });
                            }
                        });

                        // 2. Crear el registro de la devolución
                        const returnRecord = {
                            timestamp: Date.now(),
                            originalInvoiceNumber: this.foundInvoice.invoiceNumber,
                            returnedItems: returnedItemsWithCost, // Guardamos los items con su costo
                            totalRefund: this.totalRefundAmount,
                            reason: this.returnForm.reason,
                            refundMethod: this.returnForm.refundMethod,
                            user: this.employeeProfile.firstName,
                        };
                        const returnRef = doc(this.getCollectionRef('returns'));
                        batch.set(returnRef, returnRecord);

                        // 3. Ejecutar las operaciones
                        await batch.commit();

                        // Actualizar la caja local si está abierta
                        if (this.returnForm.refundMethod === 'Efectivo' && this.isCashRegisterOpen) { 
                            this.cashRegisterData.refunds.push(returnRecord); 
                        }

                        this.showNotification('Devolución Exitosa', 'La devolución ha sido procesada y el stock actualizado.', 'success');
                        this.closeModal();
                        this.foundInvoice = null;
                        this.itemsToReturn = [];
                        this.returnsInvoiceSearch = '';
                        this.returnForm = { reason: '', refundMethod: 'Efectivo' };

                    } catch (error) {
                        console.error("Error procesando devolución:", error);
                        this.showNotification('Error', 'No se pudo completar la devolución.');
                    } finally {
                        this.isLoading = false;
                    }
                }, printCreditNote() {
                    const printContents = document.getElementById('credit-note-print-area').innerHTML;
                    const printWindow = window.open('', '_blank', 'height=800,width=320');
                    if (printWindow) {
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html lang="es"><head><title>Nota de Crédito</title>
                            <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                            <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Source Code Pro', monospace; color: #000; }
                                body { width: 76mm; font-size: 10pt; line-height: 1.4; } .receipt-container { padding: 2mm; }
                                .text-center { text-align: center; } .mb-2 { margin-bottom: 8px; } .mb-4 { margin-bottom: 16px; } .font-bold { font-weight: 600; }
                                .text-lg { font-size: 14pt; } .text-xs { font-size: 8pt; } .border-t { border-top: 1px dashed #000; }
                                .border-b { border-bottom: 1px dashed #000; } .my-2 { margin-top: 8px; margin-bottom: 8px; }
                                .py-1 { padding-top: 4px; padding-bottom: 4px; } .pt-1 { padding-top: 4px; }
                                table { width: 100%; border-collapse: collapse; } th, td { padding: 3px 0; vertical-align: top; }
                                th { border-bottom: 1px solid #000; text-align: left; } .text-right { text-align: right; }
                                .text-gray-600 { color: #555; } .summary-line { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
                                .mt-1 { margin-top: 4px; } .mt-4 { margin-top: 16px; } strong { font-weight: 600; }
                                .max-h-20 { max-height: 5rem; } .mx-auto { margin-left: auto; margin-right: auto; }
                                .whitespace-pre-wrap { white-space: pre-wrap; }
                                @media print { @page { size: 80mm auto; margin: 0; } body { width: 100%; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
                            </style></head><body><div class="receipt-container">${printContents}</div></body></html>`);
                        printWindow.document.close();
                        setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
                    } else { this.showNotification('Error de Impresión', 'No se pudo abrir la ventana de impresión.'); }
                }, async handleConfirmReturn() {
                    const itemsBeingReturned = this.itemsToReturn.filter(i => i.isReturning && i.returnQuantity > 0);
                    if (itemsBeingReturned.length === 0) { this.showNotification('Error', 'No has seleccionado ningún producto para devolver.'); return; }

                    this.isLoading = true;
                    try {
                        const batch = writeBatch(db);
                        const returnId = `DEV-${Date.now()}`;

                        const returnedItemsWithCost = itemsBeingReturned.map(item => {
                            const originalProduct = this.allProducts.find(p => p.sku === item.sku);
                            return { ...item, purchasePrice: originalProduct ? originalProduct.purchasePrice : 0 };
                        });

                        returnedItemsWithCost.forEach(item => {
                            const productDoc = this.allProducts.find(p => p.sku === item.sku);
                            if(productDoc) {
                                const productRef = doc(this.getCollectionRef('products'), productDoc.id);
                                const newStock = productDoc.stock + item.returnQuantity;
                                batch.update(productRef, { stock: newStock });
                            }
                        });

                        const returnRecord = {
                            id: returnId, // Guardamos un ID legible
                            timestamp: Date.now(),
                            originalInvoiceNumber: this.foundInvoice.invoiceNumber,
                            returnedItems: returnedItemsWithCost,
                            totalRefund: this.totalRefundAmount,
                            reason: this.returnForm.reason,
                            refundMethod: this.returnForm.refundMethod,
                            user: this.employeeProfile.firstName,
                        };
                        const returnRef = doc(this.getCollectionRef('returns'), returnId); // Usamos el ID legible
                        batch.set(returnRef, returnRecord);

                        await batch.commit();

                        if (this.returnForm.refundMethod === 'Efectivo' && this.isCashRegisterOpen) { 
                            this.cashRegisterData.refunds.push(returnRecord); 
                        }

                        // Limpiamos el formulario y cerramos el modal de procesamiento
                        this.foundInvoice = null;
                        this.itemsToReturn = [];
                        this.returnsInvoiceSearch = '';
                        this.returnForm = { reason: '', refundMethod: 'Efectivo' };
                        this.closeModal(); // Cierra el modal de "Confirmar Devolución"

                        // ¡AQUÍ LA NUEVA LÓGICA!
                        // 1. Mostramos la notificación de éxito que pediste
                        this.showNotification('Devolución Exitosa', 'La devolución ha sido procesada y el stock actualizado.', 'success');

                        // 2. Abrimos el nuevo modal con el comprobante para imprimir
                        this.openModal('creditNote', { returnRecord });

                    } catch (error) {
                        console.error("Error procesando devolución:", error);
                        this.showNotification('Error', 'No se pudo completar la devolución.');
                    } finally {
                        this.isLoading = false;
                    }
                }, handleFindInvoice() {
                    const invoiceId = this.returnsInvoiceSearch.trim();
                    if (!invoiceId) return;

                    const invoice = this.salesHistory.find(s => s.invoiceNumber === invoiceId);

                    if (!invoice) {
                        this.showNotification('Factura no encontrada', 'No se encontró ninguna venta con ese número de factura.');
                        this.foundInvoice = null;
                        this.itemsToReturn = [];
                        return;
                    }

                    // --- ¡AQUÍ EMPIEZA LA NUEVA LÓGICA DE VERIFICACIÓN! ---

                    // 1. Buscamos todas las devoluciones previas para esta factura.
                    const previousReturns = this.returnsHistory.filter(r => r.originalInvoiceNumber === invoiceId);

                    // 2. Creamos un mapa para contar cuántas unidades de cada SKU ya se han devuelto.
                    const alreadyReturnedMap = {};
                    previousReturns.forEach(ret => {
                        ret.returnedItems.forEach(item => {
                            if (!alreadyReturnedMap[item.sku]) {
                                alreadyReturnedMap[item.sku] = 0;
                            }
                            alreadyReturnedMap[item.sku] += item.returnQuantity;
                        });
                    });

                    // 3. Preparamos la lista de items, ajustando las cantidades disponibles para devolver.
                    const availableItemsToReturn = JSON.parse(JSON.stringify(invoice.items)).map(item => {
                        const returnedQty = alreadyReturnedMap[item.sku] || 0;
                        const availableQty = item.quantity - returnedQty;
                        
                        return {
                            ...item,
                            isReturning: availableQty > 0, // El checkbox se marca por defecto si hay items disponibles
                            returnQuantity: availableQty, // La cantidad a devolver es la máxima disponible
                            maxQuantity: availableQty, // Guardamos la cantidad máxima que se puede devolver
                            status: availableQty <= 0 ? 'YA DEVUELTO' : 'DISPONIBLE'
                        };
                    });
                    
                    // 4. Verificamos si aún queda algo por devolver en toda la factura.
                    const totalAvailableQty = availableItemsToReturn.reduce((sum, item) => sum + item.maxQuantity, 0);

                    if (totalAvailableQty <= 0) {
                        this.showNotification('Devolución Completa', 'Todos los artículos de esta factura ya han sido devueltos previamente.');
                        this.foundInvoice = invoice; // Mostramos los detalles de la factura...
                        this.itemsToReturn = availableItemsToReturn; // ...y su estado de "YA DEVUELTO".
                        return;
                    }

                    // Si llegamos aquí, es porque hay una devolución parcial o no se ha devuelto nada.
                    this.foundInvoice = invoice;
                    this.itemsToReturn = availableItemsToReturn;
                }, confirmForceLogout(user) {
                    this.showConfirmation(
                        'Forzar Cierre de Sesión',
                        `¿Estás seguro de que quieres cerrar la sesión de <strong>${user.firstName} ${user.lastName}</strong>? Se cerrará en todos los dispositivos donde esté abierta.`,
                        async () => {
                            try {
                                const userRef = doc(this.getCollectionRef('profiles'), user.id);
                                // Actualizamos el timestamp. El listener en el otro navegador detectará este cambio.
                                await updateDoc(userRef, {
                                    forceLogoutTimestamp: Date.now()
                                });
                                this.showNotification('Sesión Cerrada', `La sesión de ${user.firstName} ha sido cerrada forzosamente.`, 'success');
                            } catch (error) {
                                console.error("Error forzando cierre de sesión:", error);
                                this.showNotification('Error', 'No se pudo forzar el cierre de sesión.');
                            }
                        }
                    );
                },confirmDeleteUser(user) {
                    // Verificación para no borrar el perfil que se está usando actualmente
                    if (user.id === this.employeeProfile.id) {
                        this.showNotification('Acción no permitida', 'No puedes eliminar tu propio perfil mientras tienes la sesión iniciada.');
                        return;
                    }

                    this.showConfirmation(
                        'Eliminar Perfil de Empleado',
                        `¿Estás seguro de que quieres eliminar permanentemente el perfil de <strong>${user.firstName} ${user.lastName}</strong>? Esta acción no se puede deshacer.`,
                        async () => {
                            try {
                                const userRef = doc(this.getCollectionRef('profiles'), user.id);
                                await deleteDoc(userRef);
                                this.showNotification('Perfil Eliminado', `El perfil de ${user.firstName} ha sido eliminado.`, 'success');
                            } catch (error) {
                                console.error("Error eliminando perfil:", error);
                                this.showNotification('Error', 'No se pudo eliminar el perfil.');
                            }
                        }
                    );
                }, async toggleUserBlockStatus(user) {
                    const newStatus = !user.isBlocked;
                    const actionText = newStatus ? 'bloquear' : 'desbloquear';

                    this.showConfirmation(
                        `Confirmar ${actionText.charAt(0).toUpperCase() + actionText.slice(1)}`,
                        `¿Estás seguro de que quieres <strong>${actionText}</strong> el perfil de <strong>${user.firstName}</strong>?`,
                        async () => {
                            try {
                                const userRef = doc(this.getCollectionRef('profiles'), user.id);
                                let updateData = { isBlocked: newStatus };

                                // Si estamos bloqueando al usuario, también forzamos su cierre de sesión actual.
                                if (newStatus) {
                                    updateData.forceLogoutTimestamp = Date.now();
                                }
                                
                                await updateDoc(userRef, updateData);
                                this.showNotification('Éxito', `El perfil ha sido ${actionText === 'bloquear' ? 'bloqueado' : 'desbloqueado'}.`, 'success');
                            } catch (error) {
                                console.error(`Error al ${actionText} el perfil:`, error);
                                this.showNotification('Error', `No se pudo ${actionText} el perfil.`);
                            }
                        }
                    );
                },

                // Reports Deletion
                // Pega este bloque completo en tu objeto 'methods'

confirmDeleteSale(sale) {
    this.showConfirmation('Eliminar Venta', `¿Seguro que quieres eliminar la factura <strong>${sale.invoiceNumber}</strong>? Esta acción es permanente.`, async () => {
        try {
            const docRef = doc(this.getCollectionRef('sales'), sale.id);
            await deleteDoc(docRef);
            this.showNotification('Éxito', 'La venta ha sido eliminada permanentemente.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar la venta de la base de datos.');
        }
    });
},
confirmDeleteAllSales() {
    this.showConfirmation('Eliminar TODO', `¿Seguro que quieres eliminar <strong>TODAS las ${this.salesHistory.length}</strong> ventas del historial? Esta acción es irreversible.`, async () => {
        if (this.salesHistory.length === 0) return;
        try {
            const batch = writeBatch(db);
            this.salesHistory.forEach(sale => {
                const docRef = doc(this.getCollectionRef('sales'), sale.id);
                batch.delete(docRef);
            });
            await batch.commit();
            this.showNotification('Éxito', 'Todo el historial de ventas ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el historial de ventas.');
        }
    });
},
confirmDeleteReturn(item) {
    this.showConfirmation('Eliminar Devolución', `¿Seguro que quieres eliminar este registro de devolución?`, async () => {
        try {
            const docRef = doc(this.getCollectionRef('returns'), item.id);
            await deleteDoc(docRef);
            this.showNotification('Éxito', 'El registro de devolución ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el registro.');
        }
    });
},
confirmDeleteAllReturns() {
    this.showConfirmation('Eliminar TODO', `¿Seguro que quieres eliminar <strong>TODOS los ${this.returnsHistory.length}</strong> registros de devoluciones?`, async () => {
        if (this.returnsHistory.length === 0) return;
        try {
            const batch = writeBatch(db);
            this.returnsHistory.forEach(item => {
                const docRef = doc(this.getCollectionRef('returns'), item.id);
                batch.delete(docRef);
            });
            await batch.commit();
            this.showNotification('Éxito', 'Todo el historial de devoluciones ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el historial.');
        }
    });
},
confirmDeleteCashSession(session) {
    this.showConfirmation('Eliminar Sesión de Caja', `¿Seguro que quieres eliminar esta sesión del historial?`, async () => {
        try {
            const docRef = doc(this.getCollectionRef('cashRegisterHistory'), session.id);
            await deleteDoc(docRef);
            this.showNotification('Éxito', 'La sesión ha sido eliminada.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar la sesión.');
        }
    });
},
confirmDeleteAllCashSessions() {
    this.showConfirmation('Eliminar TODO', `¿Seguro que quieres eliminar <strong>TODAS las ${this.cashRegisterHistory.length}</strong> sesiones de caja?`, async () => {
        if (this.cashRegisterHistory.length === 0) return;
        try {
            const batch = writeBatch(db);
            this.cashRegisterHistory.forEach(session => {
                const docRef = doc(this.getCollectionRef('cashRegisterHistory'), session.id);
                batch.delete(docRef);
            });
            await batch.commit();
            this.showNotification('Éxito', 'Todo el historial de caja ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el historial.');
        }
    });
},
confirmDeleteEntry(item) {
    this.showConfirmation('Eliminar Registro de Entrada', `¿Seguro que quieres eliminar este registro?`, async () => {
        try {
            const docRef = doc(this.getCollectionRef('stock_entries'), item.id);
            await deleteDoc(docRef);
            this.showNotification('Éxito', 'El registro de entrada ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el registro.');
        }
    });
},
confirmDeleteAllEntries() {
    this.showConfirmation('Eliminar TODO', `¿Seguro que quieres eliminar <strong>TODOS los ${this.entryHistory.length}</strong> registros de entrada?`, async () => {
        if (this.entryHistory.length === 0) return;
        try {
            const batch = writeBatch(db);
            this.entryHistory.forEach(item => {
                const docRef = doc(this.getCollectionRef('stock_entries'), item.id);
                batch.delete(docRef);
            });
            await batch.commit();
            this.showNotification('Éxito', 'Todo el historial de entradas ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el historial.');
        }
    });
},
confirmDeleteWastage(item) {
    this.showConfirmation('Eliminar Registro de Merma', `¿Seguro que quieres eliminar este registro?`, async () => {
        try {
            const docRef = doc(this.getCollectionRef('stock_wastage'), item.id);
            await deleteDoc(docRef);
            this.showNotification('Éxito', 'El registro de merma ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el registro.');
        }
    });
},
confirmDeleteAllWastage() {
    this.showConfirmation('Eliminar TODO', `¿Seguro que quieres eliminar <strong>TODOS los ${this.wastageHistory.length}</strong> registros de merma?`, async () => {
        if (this.wastageHistory.length === 0) return;
        try {
            const batch = writeBatch(db);
            this.wastageHistory.forEach(item => {
                const docRef = doc(this.getCollectionRef('stock_wastage'), item.id);
                batch.delete(docRef);
            });
            await batch.commit();
            this.showNotification('Éxito', 'Todo el historial de mermas ha sido eliminado.', 'success');
        } catch (error) {
            this.showNotification('Error', 'No se pudo eliminar el historial.');
        }
    });
},             
 getDifferenceClass(diff) { if (diff === 0) return 'text-green-600'; return diff > 0 ? 'text-yellow-600' : 'text-red-600'; },
                openDateFilter() {
    this.tempDateFilters = { ...this.dateFilters };
    this.isDateFilterPopoverOpen = true;
},
applyDateFilters() {
    this.dateFilters = { ...this.tempDateFilters };
    this.isDateFilterPopoverOpen = false;
},
clearDateFilters() {
    this.tempDateFilters = { start: '', end: '' };
    this.dateFilters = { start: '', end: '' };
    this.isDateFilterPopoverOpen = false;
},
calculateSaleProfit(sale) {
    if (!sale || !sale.items) return 0;

    // 1. Calculamos la ganancia bruta (basada en el precio original)
    const grossProfit = sale.items.reduce((profit, item) => {
        const product = this.allProducts.find(p => p.sku === item.sku);
        const cost = product ? (product.purchasePrice || 0) : 0;
        return profit + ((item.price - cost) * item.quantity);
    }, 0);

    // 2. Obtenemos el descuento que se aplicó en esa venta (si no hubo, es 0)
    const discount = sale.discount || 0;

    // 3. La ganancia real es la ganancia bruta MENOS el descuento aplicado
    return grossProfit - discount;
},
 calculateReturnLoss(ret) {
        return ret.returnedItems.reduce((loss, item) => {
            const cost = item.purchasePrice || 0;
            const profitLostPerItem = item.price - cost;
            return loss + (profitLostPerItem * item.returnQuantity);
        }, 0);
    },// Dentro de methods: { ... }
},
updated() {
        // Esta función se ejecuta automáticamente CADA VEZ que Vue actualiza la pantalla.
        this.refreshIcons();
    },

            mounted() {
                setTimeout(() => { onAuthStateChanged(auth, (user) => { if (!user) { this.mainUser = null; this.employeeProfile = null; this.currentView = 'auth'; this.refreshIcons(); } else { this.mainUser = user; this.checkUserStatus(user); } }); }, 1500);
                window.addEventListener('click', this.closeAllDropdowns);
                this.businessInfoForm = { ...this.businessInfo };
            },
            beforeUnmount() {
                window.removeEventListener('click', this.closeAllDropdowns); 
            }
        }).mount('#app');
    </script>
</body>
</html>
